# WARNING: DO NOT EDIT THIS FILE!!!
#
# This file is autogenerated from .github/workflows/ci-cd.yml.erb
# by ./internal-scripts/generate-ci-cd-yaml.rb.
# Please edit the .erb file instead, then regenerate YAML
# by running that script.
#
# TIP: run this on your development machine to ensure generate-ci-cd-yaml.rb
# is run automatically as a Git pre-commit hook:
#
#   git config core.hooksPath .githooks

name: CI/CD

on:
  workflow_dispatch: {}
  push:
    paths-ignore:
      - '**.md'
      - 'dev-handbook/**'

env:
  BINTRAY_ORG: fullstaq
  CI_ARTIFACTS_BUCKET: fullstaq-ruby-server-edition-ci-artifacts
  ## Set the following variable to a specific number to make the
  ## Google Cloud artifact upload/download actions treat as
  ## if we're running the given CI run number. Useful for
  ## speeding up development of the CI itself, in order to
  ## avoid rebuilding.
  CI_ARTIFACTS_RUN_NUMBER: ${{ github.run_number }}

jobs:
  check_workflow_uptodate:
    name: Check whether workflow is up-to-date
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-ruby@v1
        with:
          ruby-version: '2.6'

      - name: Check
        run: ./internal-scripts/ci-cd/check-workflow-uptodate/check.sh
      - name: Show differences
        run: git diff --no-index --color .github/workflows/ci-cd.yml .github/workflows/ci-cd.yml.2
        if: '!cancelled() && failure()'


  check_version_numbers_need_bumping:
    name: Check whether any version numbers need to be changed
    needs:
      - download_rbenv_source
    runs-on: ubuntu-20.04
    # Run even if a dependent job has been skipped
    if: '!failure() && !cancelled()'
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - uses: actions/setup-ruby@v1
        with:
          ruby-version: '2.6'
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Rbenv source
        uses: ./.github/actions/download-artifact
        with:
          name: rbenv-src
          path: .

      - name: Extract Rbenv source
        run: ./internal-scripts/ci-cd/check-version-numbers-need-changing/extract-rbenv-source.sh
      - name: Determine latest release tag
        # Sets environment variable $LATEST_RELEASE_TAG
        run: ./internal-scripts/ci-cd/check-version-numbers-need-changing/determine-latest-release-tag.sh

      - name: Check whether the Rbenv version in config.yml is correct
        run: ./internal-scripts/ci-cd/check-version-numbers-need-changing/check-rbenv-version.sh
        if: '!cancelled()'
      - name: Check whether the Rbenv package revision needs to be changed
        run: ./internal-scripts/ci-cd/check-version-numbers-need-changing/check-rbenv-package-revision.sh
        if: '!cancelled()'

      - name: Check whether the fullstaq-ruby-common Debian package version or revision needs to be changed
        run: ./internal-scripts/ci-cd/check-version-numbers-need-changing/check-common-deb-version-revision.sh
        if: '!cancelled()'
      - name: Check whether the fullstaq-ruby-common RPM package version or revision needs to be changed
        run: ./internal-scripts/ci-cd/check-version-numbers-need-changing/check-common-rpm-version-revision.sh
        if: '!cancelled()'

      - name: Check whether any Ruby package revisions need to be changed
        run: ./internal-scripts/ci-cd/check-version-numbers-need-changing/check-ruby-package-revisions.sh
        if: '!cancelled()'

      - name: Check whether any minor Ruby package revisions need to be changed
        run: ./internal-scripts/ci-cd/check-version-numbers-need-changing/check-minor-ruby-package-revisions.sh
        if: '!cancelled()'


  # Determines which jobs should be run, or (in case this is a re-run)
  # which jobs can be skipped this time because the last run succeeded.
  # We determine this by checking whether the artifacts produced by jobs
  # exist in this run.
  determine_necessary_jobs:
    name: Determine necessary jobs
    runs-on: ubuntu-20.04
    outputs:
      necessary_jobs: ${{ steps.check.outputs.necessary_jobs }}
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}

      - name: List artifacts built in previous try of same CI run
        run: ./internal-scripts/ci-cd/determine-necessary-jobs/list-artifacts.sh
        env:
          CI_RUN_NUMBER: ${{ env.CI_ARTIFACTS_RUN_NUMBER || github.run_number }}

      - name: Determine necessary jobs
        id: check
        run: ./internal-scripts/ci-cd/determine-necessary-jobs/determine-necessary-jobs.rb


  ### Docker images ###


  build_docker_image_centos_7:
    name: 'Build Docker image [centos-7]'
    runs-on: ubuntu-18.04
    needs:
      - determine_necessary_jobs
    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-7;')
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}

      - name: Build
        run: ./internal-scripts/ci-cd/build-docker-images/build.sh
        env:
          IMAGE_NAME: 'fullstaq/ruby-build-env-centos-7'
          IMAGE_TAG: '3'
          SOURCE_DIR: 'environments/centos-7'

      - name: Dump image
        run: ./internal-scripts/ci-cd/build-docker-images/dump-image.sh
        env:
          IMAGE_NAME: 'fullstaq/ruby-build-env-centos-7'
          IMAGE_TAG: '3'
      - name: Archive artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: 'docker-image-centos-7'
          path: output

  build_docker_image_centos_8:
    name: 'Build Docker image [centos-8]'
    runs-on: ubuntu-18.04
    needs:
      - determine_necessary_jobs
    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-8;')
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}

      - name: Build
        run: ./internal-scripts/ci-cd/build-docker-images/build.sh
        env:
          IMAGE_NAME: 'fullstaq/ruby-build-env-centos-8'
          IMAGE_TAG: '1'
          SOURCE_DIR: 'environments/centos-8'

      - name: Dump image
        run: ./internal-scripts/ci-cd/build-docker-images/dump-image.sh
        env:
          IMAGE_NAME: 'fullstaq/ruby-build-env-centos-8'
          IMAGE_TAG: '1'
      - name: Archive artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: 'docker-image-centos-8'
          path: output

  build_docker_image_debian_10:
    name: 'Build Docker image [debian-10]'
    runs-on: ubuntu-18.04
    needs:
      - determine_necessary_jobs
    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-10;')
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}

      - name: Build
        run: ./internal-scripts/ci-cd/build-docker-images/build.sh
        env:
          IMAGE_NAME: 'fullstaq/ruby-build-env-debian-10'
          IMAGE_TAG: '1'
          SOURCE_DIR: 'environments/debian-10'

      - name: Dump image
        run: ./internal-scripts/ci-cd/build-docker-images/dump-image.sh
        env:
          IMAGE_NAME: 'fullstaq/ruby-build-env-debian-10'
          IMAGE_TAG: '1'
      - name: Archive artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: 'docker-image-debian-10'
          path: output

  build_docker_image_debian_9:
    name: 'Build Docker image [debian-9]'
    runs-on: ubuntu-18.04
    needs:
      - determine_necessary_jobs
    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-9;')
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}

      - name: Build
        run: ./internal-scripts/ci-cd/build-docker-images/build.sh
        env:
          IMAGE_NAME: 'fullstaq/ruby-build-env-debian-9'
          IMAGE_TAG: '2'
          SOURCE_DIR: 'environments/debian-9'

      - name: Dump image
        run: ./internal-scripts/ci-cd/build-docker-images/dump-image.sh
        env:
          IMAGE_NAME: 'fullstaq/ruby-build-env-debian-9'
          IMAGE_TAG: '2'
      - name: Archive artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: 'docker-image-debian-9'
          path: output

  build_docker_image_ubuntu_18_04:
    name: 'Build Docker image [ubuntu-18.04]'
    runs-on: ubuntu-18.04
    needs:
      - determine_necessary_jobs
    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-18.04;')
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}

      - name: Build
        run: ./internal-scripts/ci-cd/build-docker-images/build.sh
        env:
          IMAGE_NAME: 'fullstaq/ruby-build-env-ubuntu-18.04'
          IMAGE_TAG: '2'
          SOURCE_DIR: 'environments/ubuntu-18.04'

      - name: Dump image
        run: ./internal-scripts/ci-cd/build-docker-images/dump-image.sh
        env:
          IMAGE_NAME: 'fullstaq/ruby-build-env-ubuntu-18.04'
          IMAGE_TAG: '2'
      - name: Archive artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: 'docker-image-ubuntu-18.04'
          path: output

  build_docker_image_ubuntu_20_04:
    name: 'Build Docker image [ubuntu-20.04]'
    runs-on: ubuntu-18.04
    needs:
      - determine_necessary_jobs
    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-20.04;')
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}

      - name: Build
        run: ./internal-scripts/ci-cd/build-docker-images/build.sh
        env:
          IMAGE_NAME: 'fullstaq/ruby-build-env-ubuntu-20.04'
          IMAGE_TAG: '1'
          SOURCE_DIR: 'environments/ubuntu-20.04'

      - name: Dump image
        run: ./internal-scripts/ci-cd/build-docker-images/dump-image.sh
        env:
          IMAGE_NAME: 'fullstaq/ruby-build-env-ubuntu-20.04'
          IMAGE_TAG: '1'
      - name: Archive artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: 'docker-image-ubuntu-20.04'
          path: output

  build_docker_image_utility:
    name: 'Build Docker image [utility]'
    runs-on: ubuntu-18.04
    needs:
      - determine_necessary_jobs
    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}

      - name: Build
        run: ./internal-scripts/ci-cd/build-docker-images/build.sh
        env:
          IMAGE_NAME: 'fullstaq/ruby-build-env-utility'
          IMAGE_TAG: '3'
          SOURCE_DIR: 'environments/utility'

      - name: Dump image
        run: ./internal-scripts/ci-cd/build-docker-images/dump-image.sh
        env:
          IMAGE_NAME: 'fullstaq/ruby-build-env-utility'
          IMAGE_TAG: '3'
      - name: Archive artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: 'docker-image-utility'
          path: output



  ### Sources ###


  download_ruby_source_2_7_1:
    name: Download Ruby source [2.7.1]
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Download Ruby source 2.7.1;')
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}

      - name: Fetch cache
        id: fetch_cache
        uses: actions/cache@v1
        with:
          path: output
          key: v3-ruby-src-2.7.1

      - name: Download
        run: ./internal-scripts/ci-cd/download-ruby-sources/download.sh
        if: steps.fetch_cache.outputs.cache-hit != 'true'
        env:
          RUBY_VERSION: 2.7.1

      - name: Archive artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: ruby-src-2.7.1
          path: output
  download_ruby_source_2_6_6:
    name: Download Ruby source [2.6.6]
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Download Ruby source 2.6.6;')
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}

      - name: Fetch cache
        id: fetch_cache
        uses: actions/cache@v1
        with:
          path: output
          key: v3-ruby-src-2.6.6

      - name: Download
        run: ./internal-scripts/ci-cd/download-ruby-sources/download.sh
        if: steps.fetch_cache.outputs.cache-hit != 'true'
        env:
          RUBY_VERSION: 2.6.6

      - name: Archive artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: ruby-src-2.6.6
          path: output
  download_ruby_source_2_5_8:
    name: Download Ruby source [2.5.8]
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Download Ruby source 2.5.8;')
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}

      - name: Fetch cache
        id: fetch_cache
        uses: actions/cache@v1
        with:
          path: output
          key: v3-ruby-src-2.5.8

      - name: Download
        run: ./internal-scripts/ci-cd/download-ruby-sources/download.sh
        if: steps.fetch_cache.outputs.cache-hit != 'true'
        env:
          RUBY_VERSION: 2.5.8

      - name: Archive artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: ruby-src-2.5.8
          path: output


  download_rbenv_source:
    name: Download Rbenv source
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Download Rbenv source;')
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Prepare
        id: prepare
        run: ./internal-scripts/ci-cd/download-rbenv-source/prepare.sh
      - name: Fetch cache
        uses: actions/cache@v1
        with:
          path: output
          key: v2-rbenv-src-${{ steps.prepare.outputs.cache_key }}

      - name: Download
        run: ./internal-scripts/ci-cd/download-rbenv-source/download.sh
        env:
          RBENV_REPO_URL: ${{ steps.prepare.outputs.repo_url }}
          RBENV_REPO_REF: ${{ steps.prepare.outputs.ref }}

      - name: Archive artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: rbenv-src
          path: output


  ### Jemalloc ###


  build_jemalloc_binary_centos_7:
    name: 'Build Jemalloc binary [centos-7]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_docker_image_centos_7'
    # Run even if a dependent job has been skipped
    if: |
      contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Jemalloc [centos-7];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch cache
        uses: actions/cache@v1
        with:
          path: cache
          key: 'jemalloc-bin-centos-7-3.6.0'
      - name: Create cache dir
        run: mkdir -p cache

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-7;')
        with:
          name: 'docker-image-centos-7'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-7;')
        env:
          TARBALL: image.tar.zst

      - name: Download source
        run: ./internal-scripts/ci-cd/build-jemalloc-binaries/download-source.sh
        env:
          JEMALLOC_VERSION: "3.6.0"

      - name: Build
        run: ./internal-scripts/ci-cd/build-jemalloc-binaries/build.sh
        env:
          ENVIRONMENT_NAME: 'centos-7'

      - name: Archive artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: 'jemalloc-bin-centos-7'
          path: output
  build_jemalloc_binary_centos_8:
    name: 'Build Jemalloc binary [centos-8]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_docker_image_centos_8'
    # Run even if a dependent job has been skipped
    if: |
      contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Jemalloc [centos-8];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch cache
        uses: actions/cache@v1
        with:
          path: cache
          key: 'jemalloc-bin-centos-8-3.6.0'
      - name: Create cache dir
        run: mkdir -p cache

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-8;')
        with:
          name: 'docker-image-centos-8'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-8;')
        env:
          TARBALL: image.tar.zst

      - name: Download source
        run: ./internal-scripts/ci-cd/build-jemalloc-binaries/download-source.sh
        env:
          JEMALLOC_VERSION: "3.6.0"

      - name: Build
        run: ./internal-scripts/ci-cd/build-jemalloc-binaries/build.sh
        env:
          ENVIRONMENT_NAME: 'centos-8'

      - name: Archive artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: 'jemalloc-bin-centos-8'
          path: output
  build_jemalloc_binary_debian_10:
    name: 'Build Jemalloc binary [debian-10]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_docker_image_debian_10'
    # Run even if a dependent job has been skipped
    if: |
      contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Jemalloc [debian-10];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch cache
        uses: actions/cache@v1
        with:
          path: cache
          key: 'jemalloc-bin-debian-10-3.6.0'
      - name: Create cache dir
        run: mkdir -p cache

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-10;')
        with:
          name: 'docker-image-debian-10'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-10;')
        env:
          TARBALL: image.tar.zst

      - name: Download source
        run: ./internal-scripts/ci-cd/build-jemalloc-binaries/download-source.sh
        env:
          JEMALLOC_VERSION: "3.6.0"

      - name: Build
        run: ./internal-scripts/ci-cd/build-jemalloc-binaries/build.sh
        env:
          ENVIRONMENT_NAME: 'debian-10'

      - name: Archive artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: 'jemalloc-bin-debian-10'
          path: output
  build_jemalloc_binary_debian_9:
    name: 'Build Jemalloc binary [debian-9]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_docker_image_debian_9'
    # Run even if a dependent job has been skipped
    if: |
      contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Jemalloc [debian-9];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch cache
        uses: actions/cache@v1
        with:
          path: cache
          key: 'jemalloc-bin-debian-9-3.6.0'
      - name: Create cache dir
        run: mkdir -p cache

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-9;')
        with:
          name: 'docker-image-debian-9'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-9;')
        env:
          TARBALL: image.tar.zst

      - name: Download source
        run: ./internal-scripts/ci-cd/build-jemalloc-binaries/download-source.sh
        env:
          JEMALLOC_VERSION: "3.6.0"

      - name: Build
        run: ./internal-scripts/ci-cd/build-jemalloc-binaries/build.sh
        env:
          ENVIRONMENT_NAME: 'debian-9'

      - name: Archive artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: 'jemalloc-bin-debian-9'
          path: output
  build_jemalloc_binary_ubuntu_18_04:
    name: 'Build Jemalloc binary [ubuntu-18.04]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_docker_image_ubuntu_18_04'
    # Run even if a dependent job has been skipped
    if: |
      contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Jemalloc [ubuntu-18.04];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch cache
        uses: actions/cache@v1
        with:
          path: cache
          key: 'jemalloc-bin-ubuntu-18.04-3.6.0'
      - name: Create cache dir
        run: mkdir -p cache

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-18.04;')
        with:
          name: 'docker-image-ubuntu-18.04'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-18.04;')
        env:
          TARBALL: image.tar.zst

      - name: Download source
        run: ./internal-scripts/ci-cd/build-jemalloc-binaries/download-source.sh
        env:
          JEMALLOC_VERSION: "3.6.0"

      - name: Build
        run: ./internal-scripts/ci-cd/build-jemalloc-binaries/build.sh
        env:
          ENVIRONMENT_NAME: 'ubuntu-18.04'

      - name: Archive artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: 'jemalloc-bin-ubuntu-18.04'
          path: output
  build_jemalloc_binary_ubuntu_20_04:
    name: 'Build Jemalloc binary [ubuntu-20.04]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_docker_image_ubuntu_20_04'
    # Run even if a dependent job has been skipped
    if: |
      contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Jemalloc [ubuntu-20.04];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch cache
        uses: actions/cache@v1
        with:
          path: cache
          key: 'jemalloc-bin-ubuntu-20.04-3.6.0'
      - name: Create cache dir
        run: mkdir -p cache

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-20.04;')
        with:
          name: 'docker-image-ubuntu-20.04'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-20.04;')
        env:
          TARBALL: image.tar.zst

      - name: Download source
        run: ./internal-scripts/ci-cd/build-jemalloc-binaries/download-source.sh
        env:
          JEMALLOC_VERSION: "3.6.0"

      - name: Build
        run: ./internal-scripts/ci-cd/build-jemalloc-binaries/build.sh
        env:
          ENVIRONMENT_NAME: 'ubuntu-20.04'

      - name: Archive artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: 'jemalloc-bin-ubuntu-20.04'
          path: output


  ### fullstaq-ruby-common ###

  build_common_deb:
    name: Build common DEB
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - build_docker_image_utility
    # Run even if a dependent job has been skipped
    if: |
      contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build common DEB;')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}

      - name: Download utility Docker image
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: docker-image-utility
          path: .
      - name: Load utility Docker image
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst

      - name: Build package
        run: ./internal-scripts/ci-cd/build-common-deb/build-package.sh
        env:
          PACKAGE_BASENAME: "fullstaq-ruby-common_1.0-0_all.deb"
          VERSION: "1.0"
          REVISION: "0"

      - name: Archive artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: common-deb
          path: output


  build_common_rpm:
    name: Build common RPM
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - build_docker_image_utility
    # Run even if a dependent job has been skipped
    if: |
      contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build common RPM;')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}

      - name: Download utility Docker image
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: docker-image-utility
          path: .
      - name: Load utility Docker image
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst

      - name: Build package
        run: ./internal-scripts/ci-cd/build-common-rpm/build-package.sh
        env:
          PACKAGE_BASENAME: "fullstaq-ruby-common-1.0-0.noarch.rpm"
          VERSION: "1.0"
          REVISION: "0"

      - name: Archive artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: common-rpm
          path: output


  ### Rbenv ###

  build_rbenv_deb:
    name: Build Rbenv DEB
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - download_rbenv_source
      - build_docker_image_utility
    # Run even if a dependent job has been skipped
    if: |
      contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Rbenv DEB;')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}

      - name: Fetch Rbenv source
        uses: ./.github/actions/download-artifact
        with:
          name: rbenv-src
          path: .

      - name: Download utility Docker image
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: docker-image-utility
          path: .
      - name: Load utility Docker image
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst

      - name: Build package
        run: ./internal-scripts/ci-cd/build-rbenv-deb/build-package.sh
        env:
          PACKAGE_BASENAME: "fullstaq-rbenv_1.1.2-16-0_all.deb"
          REVISION: "0"

      - name: Archive artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: rbenv-deb
          path: output


  build_rbenv_rpm:
    name: Build Rbenv RPM
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - download_rbenv_source
      - build_docker_image_utility
    # Run even if a dependent job has been skipped
    if: |
      contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Rbenv RPM;')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}

      - name: Fetch Rbenv source
        uses: ./.github/actions/download-artifact
        with:
          name: rbenv-src
          path: .

      - name: Download utility Docker image
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: docker-image-utility
          path: .
      - name: Load utility Docker image
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst

      - name: Build package
        run: ./internal-scripts/ci-cd/build-rbenv-rpm/build-package.sh
        env:
          PACKAGE_BASENAME: "fullstaq-rbenv-1.1.2-16-0.noarch.rpm"
          REVISION: "0"

      - name: Archive artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: rbenv-rpm
          path: output


  ### Ruby ###



  build_ruby_centos_7-2_7:
    name: 'Build Ruby [centos-7/2.7]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_centos_7'
      - 'build_docker_image_centos_7'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.7.1
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-7;')
        with:
          name: 'docker-image-centos-7'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-7;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-centos-7'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.7-centos-7-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-7"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.7"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.7"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7_centos-7_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-centos-7
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.7-centos-7-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-7"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.7"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.7"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7_centos-7_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.7-centos-7-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-7"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.7"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.7"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7_centos-7_malloctrim"
          path: output-malloctrim

  build_ruby_centos_7-2_6:
    name: 'Build Ruby [centos-7/2.6]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_centos_7'
      - 'build_docker_image_centos_7'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.6.6
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-7;')
        with:
          name: 'docker-image-centos-7'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-7;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-centos-7'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.6-centos-7-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-7"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.6"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.6"
          RUBY_PACKAGE_REVISION: "6"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6_centos-7_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-centos-7
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.6-centos-7-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-7"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.6"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.6"
          RUBY_PACKAGE_REVISION: "6"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6_centos-7_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.6-centos-7-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-7"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.6"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.6"
          RUBY_PACKAGE_REVISION: "6"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6_centos-7_malloctrim"
          path: output-malloctrim

  build_ruby_centos_7-2_5:
    name: 'Build Ruby [centos-7/2.5]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_centos_7'
      - 'build_docker_image_centos_7'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.5.8
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-7;')
        with:
          name: 'docker-image-centos-7'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-7;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-centos-7'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.5-centos-7-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-7"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.5"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.5"
          RUBY_PACKAGE_REVISION: "5"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5_centos-7_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-centos-7
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.5-centos-7-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-7"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.5"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.5"
          RUBY_PACKAGE_REVISION: "5"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5_centos-7_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.5-centos-7-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-7"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.5"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.5"
          RUBY_PACKAGE_REVISION: "5"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5_centos-7_malloctrim"
          path: output-malloctrim

  build_ruby_centos_7-2_7_1:
    name: 'Build Ruby [centos-7/2.7.1]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_centos_7'
      - 'build_docker_image_centos_7'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7.1/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7.1/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7.1/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.7.1
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-7;')
        with:
          name: 'docker-image-centos-7'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-7;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-centos-7'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7.1/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7.1/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.7.1-centos-7-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7.1/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-7"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7.1/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"
          RUBY_PACKAGE_REVISION: "1"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7.1/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7.1_centos-7_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7.1/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-centos-7
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7.1/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7.1/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.7.1-centos-7-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7.1/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-7"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7.1/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"
          RUBY_PACKAGE_REVISION: "1"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7.1/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7.1_centos-7_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7.1/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7.1/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.7.1-centos-7-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7.1/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-7"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7.1/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"
          RUBY_PACKAGE_REVISION: "1"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.7.1/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7.1_centos-7_malloctrim"
          path: output-malloctrim

  build_ruby_centos_7-2_6_6:
    name: 'Build Ruby [centos-7/2.6.6]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_centos_7'
      - 'build_docker_image_centos_7'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6.6/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6.6/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6.6/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.6.6
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-7;')
        with:
          name: 'docker-image-centos-7'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-7;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-centos-7'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6.6/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6.6/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.6.6-centos-7-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6.6/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-7"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6.6/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6.6/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6.6_centos-7_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6.6/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-centos-7
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6.6/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6.6/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.6.6-centos-7-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6.6/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-7"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6.6/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6.6/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6.6_centos-7_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6.6/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6.6/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.6.6-centos-7-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6.6/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-7"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6.6/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.6.6/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6.6_centos-7_malloctrim"
          path: output-malloctrim

  build_ruby_centos_7-2_5_8:
    name: 'Build Ruby [centos-7/2.5.8]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_centos_7'
      - 'build_docker_image_centos_7'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5.8/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5.8/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5.8/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.5.8
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-7;')
        with:
          name: 'docker-image-centos-7'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-7;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-centos-7'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5.8/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5.8/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.5.8-centos-7-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5.8/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-7"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5.8/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5.8/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5.8_centos-7_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5.8/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-centos-7
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5.8/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5.8/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.5.8-centos-7-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5.8/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-7"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5.8/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5.8/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5.8_centos-7_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5.8/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5.8/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.5.8-centos-7-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5.8/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-7"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5.8/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-7/2.5.8/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5.8_centos-7_malloctrim"
          path: output-malloctrim


  build_ruby_centos_8-2_7:
    name: 'Build Ruby [centos-8/2.7]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_centos_8'
      - 'build_docker_image_centos_8'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.7.1
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-8;')
        with:
          name: 'docker-image-centos-8'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-8;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-centos-8'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.7-centos-8-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-8"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.7"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.7"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7_centos-8_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-centos-8
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.7-centos-8-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-8"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.7"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.7"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7_centos-8_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.7-centos-8-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-8"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.7"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.7"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7_centos-8_malloctrim"
          path: output-malloctrim

  build_ruby_centos_8-2_6:
    name: 'Build Ruby [centos-8/2.6]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_centos_8'
      - 'build_docker_image_centos_8'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.6.6
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-8;')
        with:
          name: 'docker-image-centos-8'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-8;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-centos-8'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.6-centos-8-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-8"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.6"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.6"
          RUBY_PACKAGE_REVISION: "6"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6_centos-8_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-centos-8
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.6-centos-8-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-8"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.6"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.6"
          RUBY_PACKAGE_REVISION: "6"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6_centos-8_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.6-centos-8-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-8"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.6"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.6"
          RUBY_PACKAGE_REVISION: "6"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6_centos-8_malloctrim"
          path: output-malloctrim

  build_ruby_centos_8-2_5:
    name: 'Build Ruby [centos-8/2.5]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_centos_8'
      - 'build_docker_image_centos_8'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.5.8
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-8;')
        with:
          name: 'docker-image-centos-8'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-8;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-centos-8'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.5-centos-8-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-8"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.5"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.5"
          RUBY_PACKAGE_REVISION: "5"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5_centos-8_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-centos-8
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.5-centos-8-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-8"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.5"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.5"
          RUBY_PACKAGE_REVISION: "5"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5_centos-8_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.5-centos-8-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-8"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.5"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.5"
          RUBY_PACKAGE_REVISION: "5"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5_centos-8_malloctrim"
          path: output-malloctrim

  build_ruby_centos_8-2_7_1:
    name: 'Build Ruby [centos-8/2.7.1]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_centos_8'
      - 'build_docker_image_centos_8'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7.1/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7.1/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7.1/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.7.1
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-8;')
        with:
          name: 'docker-image-centos-8'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-8;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-centos-8'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7.1/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7.1/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.7.1-centos-8-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7.1/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-8"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7.1/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"
          RUBY_PACKAGE_REVISION: "1"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7.1/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7.1_centos-8_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7.1/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-centos-8
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7.1/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7.1/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.7.1-centos-8-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7.1/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-8"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7.1/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"
          RUBY_PACKAGE_REVISION: "1"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7.1/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7.1_centos-8_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7.1/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7.1/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.7.1-centos-8-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7.1/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-8"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7.1/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"
          RUBY_PACKAGE_REVISION: "1"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.7.1/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7.1_centos-8_malloctrim"
          path: output-malloctrim

  build_ruby_centos_8-2_6_6:
    name: 'Build Ruby [centos-8/2.6.6]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_centos_8'
      - 'build_docker_image_centos_8'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6.6/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6.6/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6.6/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.6.6
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-8;')
        with:
          name: 'docker-image-centos-8'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-8;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-centos-8'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6.6/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6.6/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.6.6-centos-8-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6.6/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-8"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6.6/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6.6/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6.6_centos-8_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6.6/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-centos-8
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6.6/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6.6/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.6.6-centos-8-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6.6/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-8"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6.6/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6.6/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6.6_centos-8_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6.6/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6.6/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.6.6-centos-8-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6.6/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-8"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6.6/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.6.6/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6.6_centos-8_malloctrim"
          path: output-malloctrim

  build_ruby_centos_8-2_5_8:
    name: 'Build Ruby [centos-8/2.5.8]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_centos_8'
      - 'build_docker_image_centos_8'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5.8/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5.8/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5.8/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.5.8
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-8;')
        with:
          name: 'docker-image-centos-8'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-8;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-centos-8'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5.8/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5.8/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.5.8-centos-8-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5.8/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-8"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5.8/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5.8/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5.8_centos-8_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5.8/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-centos-8
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5.8/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5.8/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.5.8-centos-8-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5.8/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-8"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5.8/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5.8/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5.8_centos-8_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5.8/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5.8/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.5.8-centos-8-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5.8/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "centos-8"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5.8/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [centos-8/2.5.8/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5.8_centos-8_malloctrim"
          path: output-malloctrim


  build_ruby_debian_10-2_7:
    name: 'Build Ruby [debian-10/2.7]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_debian_10'
      - 'build_docker_image_debian_10'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.7.1
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-10;')
        with:
          name: 'docker-image-debian-10'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-10;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-debian-10'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.7-debian-10-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-10"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.7"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.7"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7_debian-10_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-debian-10
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.7-debian-10-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-10"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.7"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.7"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7_debian-10_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.7-debian-10-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-10"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.7"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.7"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7_debian-10_malloctrim"
          path: output-malloctrim

  build_ruby_debian_10-2_6:
    name: 'Build Ruby [debian-10/2.6]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_debian_10'
      - 'build_docker_image_debian_10'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.6.6
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-10;')
        with:
          name: 'docker-image-debian-10'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-10;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-debian-10'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.6-debian-10-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-10"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.6"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.6"
          RUBY_PACKAGE_REVISION: "6"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6_debian-10_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-debian-10
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.6-debian-10-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-10"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.6"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.6"
          RUBY_PACKAGE_REVISION: "6"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6_debian-10_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.6-debian-10-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-10"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.6"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.6"
          RUBY_PACKAGE_REVISION: "6"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6_debian-10_malloctrim"
          path: output-malloctrim

  build_ruby_debian_10-2_5:
    name: 'Build Ruby [debian-10/2.5]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_debian_10'
      - 'build_docker_image_debian_10'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.5.8
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-10;')
        with:
          name: 'docker-image-debian-10'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-10;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-debian-10'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.5-debian-10-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-10"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.5"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.5"
          RUBY_PACKAGE_REVISION: "5"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5_debian-10_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-debian-10
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.5-debian-10-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-10"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.5"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.5"
          RUBY_PACKAGE_REVISION: "5"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5_debian-10_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.5-debian-10-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-10"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.5"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.5"
          RUBY_PACKAGE_REVISION: "5"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5_debian-10_malloctrim"
          path: output-malloctrim

  build_ruby_debian_10-2_7_1:
    name: 'Build Ruby [debian-10/2.7.1]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_debian_10'
      - 'build_docker_image_debian_10'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7.1/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7.1/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7.1/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.7.1
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-10;')
        with:
          name: 'docker-image-debian-10'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-10;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-debian-10'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7.1/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7.1/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.7.1-debian-10-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7.1/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-10"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7.1/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"
          RUBY_PACKAGE_REVISION: "1"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7.1/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7.1_debian-10_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7.1/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-debian-10
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7.1/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7.1/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.7.1-debian-10-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7.1/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-10"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7.1/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"
          RUBY_PACKAGE_REVISION: "1"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7.1/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7.1_debian-10_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7.1/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7.1/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.7.1-debian-10-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7.1/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-10"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7.1/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"
          RUBY_PACKAGE_REVISION: "1"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.7.1/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7.1_debian-10_malloctrim"
          path: output-malloctrim

  build_ruby_debian_10-2_6_6:
    name: 'Build Ruby [debian-10/2.6.6]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_debian_10'
      - 'build_docker_image_debian_10'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6.6/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6.6/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6.6/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.6.6
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-10;')
        with:
          name: 'docker-image-debian-10'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-10;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-debian-10'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6.6/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6.6/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.6.6-debian-10-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6.6/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-10"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6.6/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6.6/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6.6_debian-10_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6.6/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-debian-10
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6.6/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6.6/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.6.6-debian-10-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6.6/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-10"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6.6/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6.6/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6.6_debian-10_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6.6/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6.6/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.6.6-debian-10-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6.6/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-10"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6.6/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.6.6/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6.6_debian-10_malloctrim"
          path: output-malloctrim

  build_ruby_debian_10-2_5_8:
    name: 'Build Ruby [debian-10/2.5.8]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_debian_10'
      - 'build_docker_image_debian_10'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5.8/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5.8/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5.8/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.5.8
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-10;')
        with:
          name: 'docker-image-debian-10'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-10;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-debian-10'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5.8/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5.8/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.5.8-debian-10-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5.8/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-10"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5.8/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5.8/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5.8_debian-10_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5.8/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-debian-10
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5.8/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5.8/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.5.8-debian-10-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5.8/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-10"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5.8/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5.8/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5.8_debian-10_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5.8/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5.8/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.5.8-debian-10-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5.8/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-10"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5.8/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-10/2.5.8/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5.8_debian-10_malloctrim"
          path: output-malloctrim


  build_ruby_debian_9-2_7:
    name: 'Build Ruby [debian-9/2.7]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_debian_9'
      - 'build_docker_image_debian_9'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.7.1
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-9;')
        with:
          name: 'docker-image-debian-9'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-9;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-debian-9'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.7-debian-9-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-9"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.7"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.7"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7_debian-9_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-debian-9
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.7-debian-9-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-9"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.7"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.7"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7_debian-9_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.7-debian-9-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-9"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.7"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.7"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7_debian-9_malloctrim"
          path: output-malloctrim

  build_ruby_debian_9-2_6:
    name: 'Build Ruby [debian-9/2.6]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_debian_9'
      - 'build_docker_image_debian_9'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.6.6
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-9;')
        with:
          name: 'docker-image-debian-9'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-9;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-debian-9'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.6-debian-9-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-9"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.6"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.6"
          RUBY_PACKAGE_REVISION: "6"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6_debian-9_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-debian-9
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.6-debian-9-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-9"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.6"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.6"
          RUBY_PACKAGE_REVISION: "6"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6_debian-9_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.6-debian-9-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-9"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.6"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.6"
          RUBY_PACKAGE_REVISION: "6"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6_debian-9_malloctrim"
          path: output-malloctrim

  build_ruby_debian_9-2_5:
    name: 'Build Ruby [debian-9/2.5]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_debian_9'
      - 'build_docker_image_debian_9'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.5.8
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-9;')
        with:
          name: 'docker-image-debian-9'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-9;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-debian-9'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.5-debian-9-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-9"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.5"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.5"
          RUBY_PACKAGE_REVISION: "5"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5_debian-9_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-debian-9
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.5-debian-9-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-9"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.5"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.5"
          RUBY_PACKAGE_REVISION: "5"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5_debian-9_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.5-debian-9-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-9"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.5"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.5"
          RUBY_PACKAGE_REVISION: "5"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5_debian-9_malloctrim"
          path: output-malloctrim

  build_ruby_debian_9-2_7_1:
    name: 'Build Ruby [debian-9/2.7.1]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_debian_9'
      - 'build_docker_image_debian_9'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7.1/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7.1/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7.1/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.7.1
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-9;')
        with:
          name: 'docker-image-debian-9'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-9;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-debian-9'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7.1/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7.1/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.7.1-debian-9-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7.1/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-9"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7.1/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"
          RUBY_PACKAGE_REVISION: "1"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7.1/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7.1_debian-9_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7.1/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-debian-9
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7.1/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7.1/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.7.1-debian-9-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7.1/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-9"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7.1/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"
          RUBY_PACKAGE_REVISION: "1"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7.1/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7.1_debian-9_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7.1/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7.1/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.7.1-debian-9-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7.1/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-9"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7.1/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"
          RUBY_PACKAGE_REVISION: "1"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.7.1/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7.1_debian-9_malloctrim"
          path: output-malloctrim

  build_ruby_debian_9-2_6_6:
    name: 'Build Ruby [debian-9/2.6.6]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_debian_9'
      - 'build_docker_image_debian_9'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6.6/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6.6/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6.6/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.6.6
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-9;')
        with:
          name: 'docker-image-debian-9'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-9;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-debian-9'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6.6/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6.6/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.6.6-debian-9-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6.6/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-9"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6.6/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6.6/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6.6_debian-9_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6.6/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-debian-9
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6.6/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6.6/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.6.6-debian-9-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6.6/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-9"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6.6/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6.6/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6.6_debian-9_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6.6/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6.6/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.6.6-debian-9-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6.6/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-9"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6.6/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.6.6/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6.6_debian-9_malloctrim"
          path: output-malloctrim

  build_ruby_debian_9-2_5_8:
    name: 'Build Ruby [debian-9/2.5.8]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_debian_9'
      - 'build_docker_image_debian_9'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5.8/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5.8/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5.8/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.5.8
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-9;')
        with:
          name: 'docker-image-debian-9'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-9;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-debian-9'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5.8/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5.8/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.5.8-debian-9-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5.8/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-9"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5.8/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5.8/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5.8_debian-9_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5.8/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-debian-9
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5.8/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5.8/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.5.8-debian-9-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5.8/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-9"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5.8/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5.8/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5.8_debian-9_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5.8/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5.8/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.5.8-debian-9-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5.8/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "debian-9"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5.8/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [debian-9/2.5.8/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5.8_debian-9_malloctrim"
          path: output-malloctrim


  build_ruby_ubuntu_18_04-2_7:
    name: 'Build Ruby [ubuntu-18.04/2.7]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_ubuntu_18_04'
      - 'build_docker_image_ubuntu_18_04'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.7.1
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-18.04;')
        with:
          name: 'docker-image-ubuntu-18.04'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-18.04;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-ubuntu-18.04'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.7-ubuntu-18.04-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-18.04"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.7"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.7"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7_ubuntu-18.04_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-ubuntu-18.04
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.7-ubuntu-18.04-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-18.04"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.7"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.7"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7_ubuntu-18.04_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.7-ubuntu-18.04-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-18.04"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.7"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.7"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7_ubuntu-18.04_malloctrim"
          path: output-malloctrim

  build_ruby_ubuntu_18_04-2_6:
    name: 'Build Ruby [ubuntu-18.04/2.6]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_ubuntu_18_04'
      - 'build_docker_image_ubuntu_18_04'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.6.6
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-18.04;')
        with:
          name: 'docker-image-ubuntu-18.04'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-18.04;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-ubuntu-18.04'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.6-ubuntu-18.04-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-18.04"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.6"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.6"
          RUBY_PACKAGE_REVISION: "6"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6_ubuntu-18.04_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-ubuntu-18.04
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.6-ubuntu-18.04-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-18.04"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.6"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.6"
          RUBY_PACKAGE_REVISION: "6"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6_ubuntu-18.04_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.6-ubuntu-18.04-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-18.04"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.6"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.6"
          RUBY_PACKAGE_REVISION: "6"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6_ubuntu-18.04_malloctrim"
          path: output-malloctrim

  build_ruby_ubuntu_18_04-2_5:
    name: 'Build Ruby [ubuntu-18.04/2.5]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_ubuntu_18_04'
      - 'build_docker_image_ubuntu_18_04'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.5.8
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-18.04;')
        with:
          name: 'docker-image-ubuntu-18.04'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-18.04;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-ubuntu-18.04'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.5-ubuntu-18.04-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-18.04"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.5"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.5"
          RUBY_PACKAGE_REVISION: "5"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5_ubuntu-18.04_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-ubuntu-18.04
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.5-ubuntu-18.04-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-18.04"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.5"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.5"
          RUBY_PACKAGE_REVISION: "5"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5_ubuntu-18.04_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.5-ubuntu-18.04-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-18.04"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.5"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.5"
          RUBY_PACKAGE_REVISION: "5"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5_ubuntu-18.04_malloctrim"
          path: output-malloctrim

  build_ruby_ubuntu_18_04-2_7_1:
    name: 'Build Ruby [ubuntu-18.04/2.7.1]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_ubuntu_18_04'
      - 'build_docker_image_ubuntu_18_04'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7.1/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7.1/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7.1/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.7.1
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-18.04;')
        with:
          name: 'docker-image-ubuntu-18.04'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-18.04;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-ubuntu-18.04'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7.1/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7.1/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.7.1-ubuntu-18.04-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7.1/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-18.04"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7.1/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"
          RUBY_PACKAGE_REVISION: "1"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7.1/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7.1_ubuntu-18.04_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7.1/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-ubuntu-18.04
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7.1/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7.1/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.7.1-ubuntu-18.04-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7.1/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-18.04"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7.1/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"
          RUBY_PACKAGE_REVISION: "1"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7.1/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7.1_ubuntu-18.04_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7.1/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7.1/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.7.1-ubuntu-18.04-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7.1/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-18.04"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7.1/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"
          RUBY_PACKAGE_REVISION: "1"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.7.1/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7.1_ubuntu-18.04_malloctrim"
          path: output-malloctrim

  build_ruby_ubuntu_18_04-2_6_6:
    name: 'Build Ruby [ubuntu-18.04/2.6.6]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_ubuntu_18_04'
      - 'build_docker_image_ubuntu_18_04'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6.6/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6.6/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6.6/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.6.6
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-18.04;')
        with:
          name: 'docker-image-ubuntu-18.04'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-18.04;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-ubuntu-18.04'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6.6/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6.6/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.6.6-ubuntu-18.04-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6.6/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-18.04"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6.6/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6.6/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6.6_ubuntu-18.04_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6.6/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-ubuntu-18.04
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6.6/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6.6/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.6.6-ubuntu-18.04-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6.6/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-18.04"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6.6/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6.6/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6.6_ubuntu-18.04_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6.6/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6.6/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.6.6-ubuntu-18.04-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6.6/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-18.04"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6.6/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.6.6/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6.6_ubuntu-18.04_malloctrim"
          path: output-malloctrim

  build_ruby_ubuntu_18_04-2_5_8:
    name: 'Build Ruby [ubuntu-18.04/2.5.8]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_ubuntu_18_04'
      - 'build_docker_image_ubuntu_18_04'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5.8/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5.8/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5.8/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.5.8
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-18.04;')
        with:
          name: 'docker-image-ubuntu-18.04'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-18.04;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-ubuntu-18.04'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5.8/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5.8/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.5.8-ubuntu-18.04-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5.8/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-18.04"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5.8/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5.8/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5.8_ubuntu-18.04_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5.8/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-ubuntu-18.04
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5.8/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5.8/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.5.8-ubuntu-18.04-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5.8/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-18.04"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5.8/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5.8/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5.8_ubuntu-18.04_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5.8/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5.8/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.5.8-ubuntu-18.04-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5.8/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-18.04"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5.8/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-18.04/2.5.8/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5.8_ubuntu-18.04_malloctrim"
          path: output-malloctrim


  build_ruby_ubuntu_20_04-2_7:
    name: 'Build Ruby [ubuntu-20.04/2.7]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_ubuntu_20_04'
      - 'build_docker_image_ubuntu_20_04'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.7.1
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-20.04;')
        with:
          name: 'docker-image-ubuntu-20.04'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-20.04;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-ubuntu-20.04'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.7-ubuntu-20.04-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-20.04"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.7"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.7"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7_ubuntu-20.04_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-ubuntu-20.04
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.7-ubuntu-20.04-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-20.04"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.7"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.7"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7_ubuntu-20.04_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.7-ubuntu-20.04-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-20.04"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.7"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.7"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7_ubuntu-20.04_malloctrim"
          path: output-malloctrim

  build_ruby_ubuntu_20_04-2_6:
    name: 'Build Ruby [ubuntu-20.04/2.6]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_ubuntu_20_04'
      - 'build_docker_image_ubuntu_20_04'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.6.6
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-20.04;')
        with:
          name: 'docker-image-ubuntu-20.04'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-20.04;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-ubuntu-20.04'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.6-ubuntu-20.04-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-20.04"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.6"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.6"
          RUBY_PACKAGE_REVISION: "6"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6_ubuntu-20.04_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-ubuntu-20.04
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.6-ubuntu-20.04-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-20.04"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.6"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.6"
          RUBY_PACKAGE_REVISION: "6"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6_ubuntu-20.04_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.6-ubuntu-20.04-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-20.04"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.6"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.6"
          RUBY_PACKAGE_REVISION: "6"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6_ubuntu-20.04_malloctrim"
          path: output-malloctrim

  build_ruby_ubuntu_20_04-2_5:
    name: 'Build Ruby [ubuntu-20.04/2.5]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_ubuntu_20_04'
      - 'build_docker_image_ubuntu_20_04'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.5.8
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-20.04;')
        with:
          name: 'docker-image-ubuntu-20.04'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-20.04;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-ubuntu-20.04'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.5-ubuntu-20.04-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-20.04"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.5"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.5"
          RUBY_PACKAGE_REVISION: "5"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5_ubuntu-20.04_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-ubuntu-20.04
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.5-ubuntu-20.04-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-20.04"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.5"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.5"
          RUBY_PACKAGE_REVISION: "5"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5_ubuntu-20.04_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.5-ubuntu-20.04-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-20.04"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.5"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.5"
          RUBY_PACKAGE_REVISION: "5"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5_ubuntu-20.04_malloctrim"
          path: output-malloctrim

  build_ruby_ubuntu_20_04-2_7_1:
    name: 'Build Ruby [ubuntu-20.04/2.7.1]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_ubuntu_20_04'
      - 'build_docker_image_ubuntu_20_04'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7.1/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7.1/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7.1/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.7.1
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-20.04;')
        with:
          name: 'docker-image-ubuntu-20.04'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-20.04;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-ubuntu-20.04'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7.1/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7.1/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.7.1-ubuntu-20.04-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7.1/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-20.04"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7.1/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"
          RUBY_PACKAGE_REVISION: "1"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7.1/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7.1_ubuntu-20.04_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7.1/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-ubuntu-20.04
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7.1/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7.1/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.7.1-ubuntu-20.04-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7.1/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-20.04"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7.1/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"
          RUBY_PACKAGE_REVISION: "1"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7.1/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7.1_ubuntu-20.04_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7.1/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7.1/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.7.1-ubuntu-20.04-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7.1/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-20.04"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7.1/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.7.1"
          RUBY_PACKAGE_REVISION: "1"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.7.1/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.7.1_ubuntu-20.04_malloctrim"
          path: output-malloctrim

  build_ruby_ubuntu_20_04-2_6_6:
    name: 'Build Ruby [ubuntu-20.04/2.6.6]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_ubuntu_20_04'
      - 'build_docker_image_ubuntu_20_04'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6.6/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6.6/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6.6/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.6.6
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-20.04;')
        with:
          name: 'docker-image-ubuntu-20.04'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-20.04;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-ubuntu-20.04'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6.6/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6.6/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.6.6-ubuntu-20.04-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6.6/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-20.04"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6.6/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6.6/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6.6_ubuntu-20.04_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6.6/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-ubuntu-20.04
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6.6/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6.6/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.6.6-ubuntu-20.04-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6.6/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-20.04"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6.6/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6.6/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6.6_ubuntu-20.04_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6.6/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6.6/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.6.6-ubuntu-20.04-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6.6/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-20.04"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6.6/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.6.6"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.6.6/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.6.6_ubuntu-20.04_malloctrim"
          path: output-malloctrim

  build_ruby_ubuntu_20_04-2_5_8:
    name: 'Build Ruby [ubuntu-20.04/2.5.8]'
    runs-on: ubuntu-20.04
    needs:
      - 'determine_necessary_jobs'
      - 'build_jemalloc_binary_ubuntu_20_04'
      - 'build_docker_image_ubuntu_20_04'
      - 'build_docker_image_utility'

      - 'download_ruby_source_2_7_1'

      - 'download_ruby_source_2_6_6'

      - 'download_ruby_source_2_5_8'

    # Run even if a dependent job has been skipped
    if: |
      (

        contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5.8/normal];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5.8/jemalloc];')

        || contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5.8/malloctrim];')

      )
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Fetch Ruby source
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.5.8
          path: .

      - name: Download Docker image necessary for building
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-20.04;')
        with:
          name: 'docker-image-ubuntu-20.04'
          path: .
      - name: Load Docker image necessary for building
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-20.04;')
        env:
          TARBALL: image.tar.zst

      - name: Download Docker image necessary for packaging
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-ubuntu-20.04'
          path: .
      - name: Load Docker image necessary for packaging
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst


      

      - name: "[normal] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5.8/normal];')
        run: mkdir cache-normal
      - name: "[normal] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5.8/normal];')
        uses: actions/cache@v2
        with:
          path: cache-normal
          key: v2-ruby-bin-2.5.8-ubuntu-20.04-normal

      - name: "[normal] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5.8/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-20.04"
          VARIANT_NAME: "normal"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"

      - name: "[normal] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5.8/normal];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[normal] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5.8/normal];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5.8_ubuntu-20.04_normal"
          path: output-normal
      
      - name: Fetch Jemalloc binary
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5.8/jemalloc];')
        uses: ./.github/actions/download-artifact
        with:
          name: jemalloc-bin-ubuntu-20.04
          path: .          

      - name: "[jemalloc] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5.8/jemalloc];')
        run: mkdir cache-jemalloc
      - name: "[jemalloc] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5.8/jemalloc];')
        uses: actions/cache@v2
        with:
          path: cache-jemalloc
          key: v2-ruby-bin-2.5.8-ubuntu-20.04-jemalloc

      - name: "[jemalloc] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5.8/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-20.04"
          VARIANT_NAME: "jemalloc"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"

      - name: "[jemalloc] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5.8/jemalloc];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[jemalloc] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5.8/jemalloc];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5.8_ubuntu-20.04_jemalloc"
          path: output-jemalloc
      

      - name: "[malloctrim] Reset & prepare workspace"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5.8/malloctrim];')
        run: mkdir cache-malloctrim
      - name: "[malloctrim] Fetch cache"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5.8/malloctrim];')
        uses: actions/cache@v2
        with:
          path: cache-malloctrim
          key: v2-ruby-bin-2.5.8-ubuntu-20.04-malloctrim

      - name: "[malloctrim] Build binaries"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5.8/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          ENVIRONMENT_NAME: "ubuntu-20.04"
          VARIANT_NAME: "malloctrim"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"

      - name: "[malloctrim] Build package"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5.8/malloctrim];')
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: "2.5.8"
          RUBY_PACKAGE_REVISION: "2"

      - name: "[malloctrim] Archive package artifact to Google Cloud"
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Ruby [ubuntu-20.04/2.5.8/malloctrim];')
        uses: ./.github/actions/upload-artifact
        with:
          name: "ruby-pkg_2.5.8_ubuntu-20.04_malloctrim"
          path: output-malloctrim



  ### Publish all artifacts in Google Cloud as Github Actions artifacts ###

  publish_github_actions_artifacts:
    name: Publish artifacts to Github Actions
    needs:
      - determine_necessary_jobs
      - download_rbenv_source
      - build_common_deb
      - build_common_rpm
      - build_rbenv_deb
      - build_rbenv_rpm

      - download_ruby_source_2_7_1

      - download_ruby_source_2_6_6

      - download_ruby_source_2_5_8


      - build_jemalloc_binary_centos_7

      - build_ruby_centos_7-2_7

      - build_ruby_centos_7-2_6

      - build_ruby_centos_7-2_5

      - build_ruby_centos_7-2_7_1

      - build_ruby_centos_7-2_6_6

      - build_ruby_centos_7-2_5_8

      - build_jemalloc_binary_centos_8

      - build_ruby_centos_8-2_7

      - build_ruby_centos_8-2_6

      - build_ruby_centos_8-2_5

      - build_ruby_centos_8-2_7_1

      - build_ruby_centos_8-2_6_6

      - build_ruby_centos_8-2_5_8

      - build_jemalloc_binary_debian_10

      - build_ruby_debian_10-2_7

      - build_ruby_debian_10-2_6

      - build_ruby_debian_10-2_5

      - build_ruby_debian_10-2_7_1

      - build_ruby_debian_10-2_6_6

      - build_ruby_debian_10-2_5_8

      - build_jemalloc_binary_debian_9

      - build_ruby_debian_9-2_7

      - build_ruby_debian_9-2_6

      - build_ruby_debian_9-2_5

      - build_ruby_debian_9-2_7_1

      - build_ruby_debian_9-2_6_6

      - build_ruby_debian_9-2_5_8

      - build_jemalloc_binary_ubuntu_18_04

      - build_ruby_ubuntu_18_04-2_7

      - build_ruby_ubuntu_18_04-2_6

      - build_ruby_ubuntu_18_04-2_5

      - build_ruby_ubuntu_18_04-2_7_1

      - build_ruby_ubuntu_18_04-2_6_6

      - build_ruby_ubuntu_18_04-2_5_8

      - build_jemalloc_binary_ubuntu_20_04

      - build_ruby_ubuntu_20_04-2_7

      - build_ruby_ubuntu_20_04-2_6

      - build_ruby_ubuntu_20_04-2_5

      - build_ruby_ubuntu_20_04-2_7_1

      - build_ruby_ubuntu_20_04-2_6_6

      - build_ruby_ubuntu_20_04-2_5_8
    runs-on: ubuntu-20.04
    # Run even if a dependent job has been skipped
    if: '!failure() && !cancelled()'
    steps:
      - uses: actions/checkout@v2
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}

      - name: Download Rbenv source artifact from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: rbenv-src
          path: artifacts
          clear: true
      - name: Archive Rbenv source artifact to Github
        uses: actions/upload-artifact@v2
        with:
          name: rbenv-src
          path: artifacts

      - name: Download common DEB artifact from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: common-deb
          path: artifacts
          clear: true
      - name: Archive common DEB artifact to Github
        uses: actions/upload-artifact@v2
        with:
          name: common-deb
          path: artifacts

      - name: Download common RPM artifact from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: common-rpm
          path: artifacts
          clear: true
      - name: Archive common RPM artifact to Github
        uses: actions/upload-artifact@v2
        with:
          name: common-rpm
          path: artifacts

      - name: Download Rbenv DEB artifact from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: rbenv-deb
          path: artifacts
          clear: true
      - name: Archive Rbenv DEB artifact to Github
        uses: actions/upload-artifact@v2
        with:
          name: rbenv-deb
          path: artifacts

      - name: Download Rbenv RPM artifact from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: rbenv-rpm
          path: artifacts
          clear: true
      - name: Archive Rbenv RPM artifact to Github
        uses: actions/upload-artifact@v2
        with:
          name: rbenv-rpm
          path: artifacts


      - name: Download Docker image artifact [centos-7] from Google Cloud
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-7;')
        with:
          name: 'docker-image-centos-7'
          path: artifacts
          clear: true
      - name: Archive Docker image artifact [centos-7] to Github
        uses: actions/upload-artifact@v2
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-7;')
        with:
          name: 'docker-image-centos-7'
          path: artifacts
      - name: Download Docker image artifact [centos-8] from Google Cloud
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-8;')
        with:
          name: 'docker-image-centos-8'
          path: artifacts
          clear: true
      - name: Archive Docker image artifact [centos-8] to Github
        uses: actions/upload-artifact@v2
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image centos-8;')
        with:
          name: 'docker-image-centos-8'
          path: artifacts
      - name: Download Docker image artifact [debian-10] from Google Cloud
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-10;')
        with:
          name: 'docker-image-debian-10'
          path: artifacts
          clear: true
      - name: Archive Docker image artifact [debian-10] to Github
        uses: actions/upload-artifact@v2
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-10;')
        with:
          name: 'docker-image-debian-10'
          path: artifacts
      - name: Download Docker image artifact [debian-9] from Google Cloud
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-9;')
        with:
          name: 'docker-image-debian-9'
          path: artifacts
          clear: true
      - name: Archive Docker image artifact [debian-9] to Github
        uses: actions/upload-artifact@v2
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image debian-9;')
        with:
          name: 'docker-image-debian-9'
          path: artifacts
      - name: Download Docker image artifact [ubuntu-18.04] from Google Cloud
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-18.04;')
        with:
          name: 'docker-image-ubuntu-18.04'
          path: artifacts
          clear: true
      - name: Archive Docker image artifact [ubuntu-18.04] to Github
        uses: actions/upload-artifact@v2
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-18.04;')
        with:
          name: 'docker-image-ubuntu-18.04'
          path: artifacts
      - name: Download Docker image artifact [ubuntu-20.04] from Google Cloud
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-20.04;')
        with:
          name: 'docker-image-ubuntu-20.04'
          path: artifacts
          clear: true
      - name: Archive Docker image artifact [ubuntu-20.04] to Github
        uses: actions/upload-artifact@v2
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image ubuntu-20.04;')
        with:
          name: 'docker-image-ubuntu-20.04'
          path: artifacts
      - name: Download Docker image artifact [utility] from Google Cloud
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-utility'
          path: artifacts
          clear: true
      - name: Archive Docker image artifact [utility] to Github
        uses: actions/upload-artifact@v2
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: 'docker-image-utility'
          path: artifacts


      - name: Download Ruby source artifact [2.7.1] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.7.1
          path: artifacts
          clear: true
      - name: Archive Ruby source artifact [2.7.1] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-src-2.7.1
          path: artifacts
      - name: Download Ruby source artifact [2.6.6] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.6.6
          path: artifacts
          clear: true
      - name: Archive Ruby source artifact [2.6.6] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-src-2.6.6
          path: artifacts
      - name: Download Ruby source artifact [2.5.8] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-src-2.5.8
          path: artifacts
          clear: true
      - name: Archive Ruby source artifact [2.5.8] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-src-2.5.8
          path: artifacts


      - name: Download Jemalloc binary artifact [centos-7] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: 'jemalloc-bin-centos-7'
          path: artifacts
          clear: true
      - name: Archive Jemalloc binary artifact [centos-7] to Github
        uses: actions/upload-artifact@v2
        with:
          name: 'jemalloc-bin-centos-7'
          path: artifacts
      - name: Download Jemalloc binary artifact [centos-8] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: 'jemalloc-bin-centos-8'
          path: artifacts
          clear: true
      - name: Archive Jemalloc binary artifact [centos-8] to Github
        uses: actions/upload-artifact@v2
        with:
          name: 'jemalloc-bin-centos-8'
          path: artifacts
      - name: Download Jemalloc binary artifact [debian-10] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: 'jemalloc-bin-debian-10'
          path: artifacts
          clear: true
      - name: Archive Jemalloc binary artifact [debian-10] to Github
        uses: actions/upload-artifact@v2
        with:
          name: 'jemalloc-bin-debian-10'
          path: artifacts
      - name: Download Jemalloc binary artifact [debian-9] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: 'jemalloc-bin-debian-9'
          path: artifacts
          clear: true
      - name: Archive Jemalloc binary artifact [debian-9] to Github
        uses: actions/upload-artifact@v2
        with:
          name: 'jemalloc-bin-debian-9'
          path: artifacts
      - name: Download Jemalloc binary artifact [ubuntu-18.04] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: 'jemalloc-bin-ubuntu-18.04'
          path: artifacts
          clear: true
      - name: Archive Jemalloc binary artifact [ubuntu-18.04] to Github
        uses: actions/upload-artifact@v2
        with:
          name: 'jemalloc-bin-ubuntu-18.04'
          path: artifacts
      - name: Download Jemalloc binary artifact [ubuntu-20.04] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: 'jemalloc-bin-ubuntu-20.04'
          path: artifacts
          clear: true
      - name: Archive Jemalloc binary artifact [ubuntu-20.04] to Github
        uses: actions/upload-artifact@v2
        with:
          name: 'jemalloc-bin-ubuntu-20.04'
          path: artifacts


      - name: Download Ruby package artifact [ruby-pkg_2.7_centos-7_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_centos-7_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7_centos-7_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7_centos-7_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7_centos-7_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_centos-7_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7_centos-7_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7_centos-7_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7_centos-7_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_centos-7_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7_centos-7_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7_centos-7_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7_centos-8_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_centos-8_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7_centos-8_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7_centos-8_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7_centos-8_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_centos-8_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7_centos-8_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7_centos-8_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7_centos-8_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_centos-8_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7_centos-8_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7_centos-8_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7_debian-10_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_debian-10_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7_debian-10_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7_debian-10_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7_debian-10_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_debian-10_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7_debian-10_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7_debian-10_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7_debian-10_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_debian-10_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7_debian-10_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7_debian-10_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7_debian-9_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_debian-9_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7_debian-9_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7_debian-9_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7_debian-9_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_debian-9_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7_debian-9_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7_debian-9_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7_debian-9_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_debian-9_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7_debian-9_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7_debian-9_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7_ubuntu-18.04_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_ubuntu-18.04_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7_ubuntu-18.04_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7_ubuntu-18.04_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7_ubuntu-18.04_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_ubuntu-18.04_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7_ubuntu-18.04_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7_ubuntu-18.04_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7_ubuntu-18.04_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_ubuntu-18.04_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7_ubuntu-18.04_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7_ubuntu-18.04_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7_ubuntu-20.04_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_ubuntu-20.04_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7_ubuntu-20.04_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7_ubuntu-20.04_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7_ubuntu-20.04_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_ubuntu-20.04_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7_ubuntu-20.04_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7_ubuntu-20.04_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7_ubuntu-20.04_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_ubuntu-20.04_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7_ubuntu-20.04_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7_ubuntu-20.04_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6_centos-7_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_centos-7_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6_centos-7_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6_centos-7_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6_centos-7_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_centos-7_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6_centos-7_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6_centos-7_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6_centos-7_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_centos-7_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6_centos-7_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6_centos-7_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6_centos-8_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_centos-8_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6_centos-8_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6_centos-8_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6_centos-8_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_centos-8_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6_centos-8_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6_centos-8_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6_centos-8_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_centos-8_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6_centos-8_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6_centos-8_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6_debian-10_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_debian-10_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6_debian-10_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6_debian-10_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6_debian-10_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_debian-10_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6_debian-10_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6_debian-10_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6_debian-10_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_debian-10_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6_debian-10_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6_debian-10_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6_debian-9_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_debian-9_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6_debian-9_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6_debian-9_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6_debian-9_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_debian-9_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6_debian-9_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6_debian-9_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6_debian-9_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_debian-9_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6_debian-9_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6_debian-9_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6_ubuntu-18.04_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_ubuntu-18.04_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6_ubuntu-18.04_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6_ubuntu-18.04_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6_ubuntu-18.04_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_ubuntu-18.04_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6_ubuntu-18.04_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6_ubuntu-18.04_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6_ubuntu-18.04_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_ubuntu-18.04_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6_ubuntu-18.04_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6_ubuntu-18.04_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6_ubuntu-20.04_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_ubuntu-20.04_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6_ubuntu-20.04_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6_ubuntu-20.04_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6_ubuntu-20.04_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_ubuntu-20.04_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6_ubuntu-20.04_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6_ubuntu-20.04_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6_ubuntu-20.04_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_ubuntu-20.04_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6_ubuntu-20.04_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6_ubuntu-20.04_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5_centos-7_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_centos-7_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5_centos-7_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5_centos-7_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5_centos-7_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_centos-7_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5_centos-7_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5_centos-7_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5_centos-7_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_centos-7_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5_centos-7_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5_centos-7_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5_centos-8_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_centos-8_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5_centos-8_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5_centos-8_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5_centos-8_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_centos-8_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5_centos-8_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5_centos-8_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5_centos-8_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_centos-8_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5_centos-8_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5_centos-8_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5_debian-10_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_debian-10_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5_debian-10_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5_debian-10_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5_debian-10_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_debian-10_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5_debian-10_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5_debian-10_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5_debian-10_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_debian-10_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5_debian-10_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5_debian-10_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5_debian-9_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_debian-9_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5_debian-9_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5_debian-9_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5_debian-9_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_debian-9_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5_debian-9_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5_debian-9_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5_debian-9_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_debian-9_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5_debian-9_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5_debian-9_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5_ubuntu-18.04_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_ubuntu-18.04_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5_ubuntu-18.04_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5_ubuntu-18.04_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5_ubuntu-18.04_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_ubuntu-18.04_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5_ubuntu-18.04_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5_ubuntu-18.04_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5_ubuntu-18.04_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_ubuntu-18.04_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5_ubuntu-18.04_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5_ubuntu-18.04_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5_ubuntu-20.04_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_ubuntu-20.04_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5_ubuntu-20.04_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5_ubuntu-20.04_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5_ubuntu-20.04_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_ubuntu-20.04_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5_ubuntu-20.04_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5_ubuntu-20.04_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5_ubuntu-20.04_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_ubuntu-20.04_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5_ubuntu-20.04_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5_ubuntu-20.04_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7.1_centos-7_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_centos-7_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7.1_centos-7_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7.1_centos-7_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7.1_centos-7_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_centos-7_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7.1_centos-7_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7.1_centos-7_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7.1_centos-7_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_centos-7_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7.1_centos-7_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7.1_centos-7_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7.1_centos-8_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_centos-8_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7.1_centos-8_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7.1_centos-8_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7.1_centos-8_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_centos-8_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7.1_centos-8_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7.1_centos-8_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7.1_centos-8_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_centos-8_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7.1_centos-8_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7.1_centos-8_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7.1_debian-10_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_debian-10_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7.1_debian-10_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7.1_debian-10_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7.1_debian-10_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_debian-10_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7.1_debian-10_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7.1_debian-10_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7.1_debian-10_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_debian-10_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7.1_debian-10_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7.1_debian-10_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7.1_debian-9_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_debian-9_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7.1_debian-9_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7.1_debian-9_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7.1_debian-9_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_debian-9_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7.1_debian-9_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7.1_debian-9_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7.1_debian-9_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_debian-9_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7.1_debian-9_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7.1_debian-9_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7.1_ubuntu-18.04_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_ubuntu-18.04_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7.1_ubuntu-18.04_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7.1_ubuntu-18.04_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7.1_ubuntu-18.04_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_ubuntu-18.04_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7.1_ubuntu-18.04_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7.1_ubuntu-18.04_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7.1_ubuntu-18.04_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_ubuntu-18.04_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7.1_ubuntu-18.04_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7.1_ubuntu-18.04_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7.1_ubuntu-20.04_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_ubuntu-20.04_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7.1_ubuntu-20.04_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7.1_ubuntu-20.04_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7.1_ubuntu-20.04_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_ubuntu-20.04_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7.1_ubuntu-20.04_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7.1_ubuntu-20.04_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.7.1_ubuntu-20.04_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_ubuntu-20.04_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.7.1_ubuntu-20.04_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.7.1_ubuntu-20.04_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6.6_centos-7_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_centos-7_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6.6_centos-7_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6.6_centos-7_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6.6_centos-7_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_centos-7_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6.6_centos-7_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6.6_centos-7_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6.6_centos-7_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_centos-7_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6.6_centos-7_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6.6_centos-7_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6.6_centos-8_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_centos-8_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6.6_centos-8_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6.6_centos-8_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6.6_centos-8_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_centos-8_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6.6_centos-8_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6.6_centos-8_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6.6_centos-8_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_centos-8_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6.6_centos-8_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6.6_centos-8_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6.6_debian-10_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_debian-10_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6.6_debian-10_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6.6_debian-10_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6.6_debian-10_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_debian-10_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6.6_debian-10_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6.6_debian-10_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6.6_debian-10_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_debian-10_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6.6_debian-10_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6.6_debian-10_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6.6_debian-9_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_debian-9_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6.6_debian-9_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6.6_debian-9_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6.6_debian-9_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_debian-9_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6.6_debian-9_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6.6_debian-9_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6.6_debian-9_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_debian-9_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6.6_debian-9_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6.6_debian-9_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6.6_ubuntu-18.04_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_ubuntu-18.04_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6.6_ubuntu-18.04_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6.6_ubuntu-18.04_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6.6_ubuntu-18.04_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_ubuntu-18.04_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6.6_ubuntu-18.04_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6.6_ubuntu-18.04_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6.6_ubuntu-18.04_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_ubuntu-18.04_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6.6_ubuntu-18.04_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6.6_ubuntu-18.04_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6.6_ubuntu-20.04_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_ubuntu-20.04_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6.6_ubuntu-20.04_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6.6_ubuntu-20.04_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6.6_ubuntu-20.04_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_ubuntu-20.04_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6.6_ubuntu-20.04_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6.6_ubuntu-20.04_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.6.6_ubuntu-20.04_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_ubuntu-20.04_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.6.6_ubuntu-20.04_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.6.6_ubuntu-20.04_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5.8_centos-7_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_centos-7_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5.8_centos-7_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5.8_centos-7_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5.8_centos-7_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_centos-7_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5.8_centos-7_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5.8_centos-7_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5.8_centos-7_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_centos-7_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5.8_centos-7_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5.8_centos-7_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5.8_centos-8_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_centos-8_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5.8_centos-8_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5.8_centos-8_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5.8_centos-8_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_centos-8_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5.8_centos-8_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5.8_centos-8_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5.8_centos-8_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_centos-8_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5.8_centos-8_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5.8_centos-8_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5.8_debian-10_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_debian-10_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5.8_debian-10_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5.8_debian-10_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5.8_debian-10_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_debian-10_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5.8_debian-10_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5.8_debian-10_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5.8_debian-10_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_debian-10_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5.8_debian-10_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5.8_debian-10_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5.8_debian-9_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_debian-9_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5.8_debian-9_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5.8_debian-9_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5.8_debian-9_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_debian-9_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5.8_debian-9_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5.8_debian-9_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5.8_debian-9_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_debian-9_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5.8_debian-9_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5.8_debian-9_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5.8_ubuntu-18.04_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_ubuntu-18.04_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5.8_ubuntu-18.04_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5.8_ubuntu-18.04_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5.8_ubuntu-18.04_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_ubuntu-18.04_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5.8_ubuntu-18.04_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5.8_ubuntu-18.04_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5.8_ubuntu-18.04_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_ubuntu-18.04_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5.8_ubuntu-18.04_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5.8_ubuntu-18.04_malloctrim
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5.8_ubuntu-20.04_normal] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_ubuntu-20.04_normal
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5.8_ubuntu-20.04_normal] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5.8_ubuntu-20.04_normal
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5.8_ubuntu-20.04_jemalloc] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_ubuntu-20.04_jemalloc
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5.8_ubuntu-20.04_jemalloc] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5.8_ubuntu-20.04_jemalloc
          path: artifacts
      - name: Download Ruby package artifact [ruby-pkg_2.5.8_ubuntu-20.04_malloctrim] from Google Cloud
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_ubuntu-20.04_malloctrim
          path: artifacts
          clear: true
      - name: Archive Ruby package artifact [ruby-pkg_2.5.8_ubuntu-20.04_malloctrim] to Github
        uses: actions/upload-artifact@v2
        with:
          name: ruby-pkg_2.5.8_ubuntu-20.04_malloctrim
          path: artifacts


  ### Create test APT/YUM repos ###

  create_test_apt_repo:
    name: Create test APT repo
    runs-on: ubuntu-20.04
    needs:
      - check_workflow_uptodate
      - check_version_numbers_need_bumping
    steps:
      - uses: actions/checkout@v2
      - name: Recreate repo
        run: ./internal-scripts/ci-cd/publish/recreate-apt-repo.sh
        env:
          BINTRAY_API_USERNAME: ${{ secrets.BINTRAY_API_USERNAME }}
          BINTRAY_API_KEY: ${{ secrets.BINTRAY_API_KEY }}
          REPO_NAME: fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}


  create_test_yum_repo:
    name: Create test YUM repo
    runs-on: ubuntu-20.04
    needs:
      - check_workflow_uptodate
      - check_version_numbers_need_bumping
    steps:
      - uses: actions/checkout@v2
      - name: Recreate repo
        run: ./internal-scripts/ci-cd/publish/recreate-yum-repo.sh
        env:
          BINTRAY_API_USERNAME: ${{ secrets.BINTRAY_API_USERNAME }}
          BINTRAY_API_KEY: ${{ secrets.BINTRAY_API_KEY }}
          REPO_NAME: fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}


  ### Publish common and fullstaq-rbenv packages to test repos

  publish_common_and_rbenv_debs_test:
    name: Publish common and Rbenv DEBs to test repo
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - build_docker_image_utility
      - create_test_apt_repo
      - build_common_deb
      - build_rbenv_deb
    # Run even if a dependent job has been skipped
    if: '!failure() && !cancelled()'
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}

      - name: Download common DEB
        uses: ./.github/actions/download-artifact
        with:
          name: common-deb
          path: .
      - name: Download Rbenv DEB
        uses: ./.github/actions/download-artifact
        with:
          name: rbenv-deb
          path: .

      - name: Download utility Docker image
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: docker-image-utility
          path: .
      - name: Load utility Docker image
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst

      - name: Determine latest release tag
        # Sets environment variable $LATEST_RELEASE_TAG
        run: ./internal-scripts/ci-cd/check-version-numbers-need-changing/determine-latest-release-tag.sh
      - name: Determine Bintray repository package version
        # Sets environment variable $REPO_PACKAGE_VERSION
        run: ./internal-scripts/ci-cd/publish/determine-repo-package-version.sh

      - name: Upload to repo
        run: ./internal-scripts/ci-cd/publish/publish-debs.sh *.deb
        env:
          BINTRAY_API_USERNAME: ${{ secrets.BINTRAY_API_USERNAME }}
          BINTRAY_API_KEY: ${{ secrets.BINTRAY_API_KEY }}
          REPO_NAME: fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          DRY_RUN: false
          IGNORE_EXISTING: false


  publish_common_and_rbenv_rpms_test:
    name: Publish common and Rbenv RPMs to test repo
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - build_docker_image_utility
      - create_test_yum_repo
      - build_common_rpm
      - build_rbenv_rpm
    # Run even if a dependent job has been skipped
    if: '!failure() && !cancelled()'
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}

      - name: Download common RPM
        uses: ./.github/actions/download-artifact
        with:
          name: common-rpm
          path: .
      - name: Download Rbenv RPM
        uses: ./.github/actions/download-artifact
        with:
          name: rbenv-rpm
          path: .

      - name: Download utility Docker image
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: docker-image-utility
          path: .
      - name: Load utility Docker image
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst

      - name: Determine latest release tag
        # Sets environment variable $LATEST_RELEASE_TAG
        run: ./internal-scripts/ci-cd/check-version-numbers-need-changing/determine-latest-release-tag.sh
      - name: Determine Bintray repository package version
        # Sets environment variable $REPO_PACKAGE_VERSION
        run: ./internal-scripts/ci-cd/publish/determine-repo-package-version.sh

      - name: Upload to repo
        run: ./internal-scripts/ci-cd/publish/publish-rpms.sh *.rpm
        env:
          BINTRAY_API_USERNAME: ${{ secrets.BINTRAY_API_USERNAME }}
          BINTRAY_API_KEY: ${{ secrets.BINTRAY_API_KEY }}
          REPO_NAME: fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          DRY_RUN: false
          IGNORE_EXISTING: false


  ### Publish Ruby packages to test repos

  publish_ruby_packages_test:
    name: Publish Ruby packages to test repo
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - build_docker_image_utility
      - create_test_apt_repo
      - create_test_yum_repo
      - build_common_deb
      - build_rbenv_deb
      - build_common_rpm
      - build_rbenv_rpm

      - build_ruby_centos_7-2_7

      - build_ruby_centos_7-2_6

      - build_ruby_centos_7-2_5

      - build_ruby_centos_7-2_7_1

      - build_ruby_centos_7-2_6_6

      - build_ruby_centos_7-2_5_8


      - build_ruby_centos_8-2_7

      - build_ruby_centos_8-2_6

      - build_ruby_centos_8-2_5

      - build_ruby_centos_8-2_7_1

      - build_ruby_centos_8-2_6_6

      - build_ruby_centos_8-2_5_8


      - build_ruby_debian_10-2_7

      - build_ruby_debian_10-2_6

      - build_ruby_debian_10-2_5

      - build_ruby_debian_10-2_7_1

      - build_ruby_debian_10-2_6_6

      - build_ruby_debian_10-2_5_8


      - build_ruby_debian_9-2_7

      - build_ruby_debian_9-2_6

      - build_ruby_debian_9-2_5

      - build_ruby_debian_9-2_7_1

      - build_ruby_debian_9-2_6_6

      - build_ruby_debian_9-2_5_8


      - build_ruby_ubuntu_18_04-2_7

      - build_ruby_ubuntu_18_04-2_6

      - build_ruby_ubuntu_18_04-2_5

      - build_ruby_ubuntu_18_04-2_7_1

      - build_ruby_ubuntu_18_04-2_6_6

      - build_ruby_ubuntu_18_04-2_5_8


      - build_ruby_ubuntu_20_04-2_7

      - build_ruby_ubuntu_20_04-2_6

      - build_ruby_ubuntu_20_04-2_5

      - build_ruby_ubuntu_20_04-2_7_1

      - build_ruby_ubuntu_20_04-2_6_6

      - build_ruby_ubuntu_20_04-2_5_8

    # Run even if a dependent job has been skipped
    if: '!failure() && !cancelled()'
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}


      - name: Fetch ruby-pkg_2.7_centos-7_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_centos-7_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7_centos-7_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_centos-7_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7_centos-7_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_centos-7_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7_centos-8_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_centos-8_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7_centos-8_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_centos-8_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7_centos-8_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_centos-8_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7_debian-10_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_debian-10_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7_debian-10_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_debian-10_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7_debian-10_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_debian-10_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7_debian-9_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_debian-9_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7_debian-9_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_debian-9_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7_debian-9_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_debian-9_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7_ubuntu-18.04_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_ubuntu-18.04_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7_ubuntu-18.04_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_ubuntu-18.04_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7_ubuntu-18.04_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_ubuntu-18.04_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7_ubuntu-20.04_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_ubuntu-20.04_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7_ubuntu-20.04_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_ubuntu-20.04_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7_ubuntu-20.04_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_ubuntu-20.04_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6_centos-7_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_centos-7_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6_centos-7_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_centos-7_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6_centos-7_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_centos-7_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6_centos-8_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_centos-8_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6_centos-8_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_centos-8_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6_centos-8_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_centos-8_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6_debian-10_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_debian-10_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6_debian-10_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_debian-10_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6_debian-10_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_debian-10_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6_debian-9_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_debian-9_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6_debian-9_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_debian-9_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6_debian-9_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_debian-9_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6_ubuntu-18.04_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_ubuntu-18.04_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6_ubuntu-18.04_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_ubuntu-18.04_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6_ubuntu-18.04_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_ubuntu-18.04_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6_ubuntu-20.04_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_ubuntu-20.04_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6_ubuntu-20.04_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_ubuntu-20.04_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6_ubuntu-20.04_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_ubuntu-20.04_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5_centos-7_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_centos-7_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5_centos-7_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_centos-7_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5_centos-7_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_centos-7_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5_centos-8_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_centos-8_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5_centos-8_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_centos-8_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5_centos-8_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_centos-8_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5_debian-10_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_debian-10_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5_debian-10_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_debian-10_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5_debian-10_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_debian-10_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5_debian-9_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_debian-9_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5_debian-9_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_debian-9_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5_debian-9_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_debian-9_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5_ubuntu-18.04_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_ubuntu-18.04_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5_ubuntu-18.04_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_ubuntu-18.04_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5_ubuntu-18.04_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_ubuntu-18.04_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5_ubuntu-20.04_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_ubuntu-20.04_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5_ubuntu-20.04_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_ubuntu-20.04_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5_ubuntu-20.04_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_ubuntu-20.04_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7.1_centos-7_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_centos-7_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7.1_centos-7_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_centos-7_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7.1_centos-7_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_centos-7_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7.1_centos-8_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_centos-8_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7.1_centos-8_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_centos-8_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7.1_centos-8_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_centos-8_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7.1_debian-10_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_debian-10_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7.1_debian-10_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_debian-10_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7.1_debian-10_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_debian-10_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7.1_debian-9_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_debian-9_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7.1_debian-9_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_debian-9_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7.1_debian-9_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_debian-9_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7.1_ubuntu-18.04_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_ubuntu-18.04_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7.1_ubuntu-18.04_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_ubuntu-18.04_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7.1_ubuntu-18.04_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_ubuntu-18.04_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7.1_ubuntu-20.04_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_ubuntu-20.04_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7.1_ubuntu-20.04_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_ubuntu-20.04_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.7.1_ubuntu-20.04_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_ubuntu-20.04_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6.6_centos-7_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_centos-7_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6.6_centos-7_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_centos-7_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6.6_centos-7_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_centos-7_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6.6_centos-8_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_centos-8_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6.6_centos-8_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_centos-8_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6.6_centos-8_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_centos-8_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6.6_debian-10_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_debian-10_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6.6_debian-10_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_debian-10_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6.6_debian-10_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_debian-10_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6.6_debian-9_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_debian-9_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6.6_debian-9_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_debian-9_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6.6_debian-9_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_debian-9_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6.6_ubuntu-18.04_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_ubuntu-18.04_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6.6_ubuntu-18.04_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_ubuntu-18.04_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6.6_ubuntu-18.04_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_ubuntu-18.04_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6.6_ubuntu-20.04_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_ubuntu-20.04_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6.6_ubuntu-20.04_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_ubuntu-20.04_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.6.6_ubuntu-20.04_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_ubuntu-20.04_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5.8_centos-7_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_centos-7_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5.8_centos-7_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_centos-7_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5.8_centos-7_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_centos-7_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5.8_centos-8_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_centos-8_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5.8_centos-8_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_centos-8_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5.8_centos-8_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_centos-8_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5.8_debian-10_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_debian-10_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5.8_debian-10_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_debian-10_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5.8_debian-10_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_debian-10_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5.8_debian-9_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_debian-9_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5.8_debian-9_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_debian-9_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5.8_debian-9_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_debian-9_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5.8_ubuntu-18.04_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_ubuntu-18.04_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5.8_ubuntu-18.04_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_ubuntu-18.04_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5.8_ubuntu-18.04_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_ubuntu-18.04_malloctrim
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5.8_ubuntu-20.04_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_ubuntu-20.04_normal
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5.8_ubuntu-20.04_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_ubuntu-20.04_jemalloc
          path: ruby-pkgs
      - name: Fetch ruby-pkg_2.5.8_ubuntu-20.04_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_ubuntu-20.04_malloctrim
          path: ruby-pkgs

      - name: Download Docker image necessary for testing
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: docker-image-utility
          path: .
      - name: Load Docker image necessary for testing
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst

      - name: Determine latest release tag
        # Sets environment variable $LATEST_RELEASE_TAG
        run: ./internal-scripts/ci-cd/check-version-numbers-need-changing/determine-latest-release-tag.sh
      - name: Determine Bintray repository package version
        # Sets environment variable $REPO_PACKAGE_VERSION
        run: ./internal-scripts/ci-cd/publish/determine-repo-package-version.sh

      - name: Upload DEBs to repo
        run: ./internal-scripts/ci-cd/publish/publish-debs.sh ruby-pkgs/*.deb
        env:
          BINTRAY_API_USERNAME: ${{ secrets.BINTRAY_API_USERNAME }}
          BINTRAY_API_KEY: ${{ secrets.BINTRAY_API_KEY }}
          REPO_NAME: fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          DRY_RUN: false
          IGNORE_EXISTING: false
      - name: Upload RPMs to repo
        run: ./internal-scripts/ci-cd/publish/publish-rpms.sh ruby-pkgs/*.rpm
        env:
          BINTRAY_API_USERNAME: ${{ secrets.BINTRAY_API_USERNAME }}
          BINTRAY_API_KEY: ${{ secrets.BINTRAY_API_KEY }}
          REPO_NAME: fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          DRY_RUN: false
          IGNORE_EXISTING: false

  commit_published_packages_test:
    name: Commit packages published to test repo
    runs-on: ubuntu-20.04
    needs:
      - publish_common_and_rbenv_debs_test
      - publish_common_and_rbenv_rpms_test
      - publish_ruby_packages_test
    # No 'if' option here: don't run if a dependent job has been
    # skipped, because that means that one of the transitive
    # dependencies failed.
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Determine latest release tag
        # Sets environment variable $LATEST_RELEASE_TAG
        run: ./internal-scripts/ci-cd/check-version-numbers-need-changing/determine-latest-release-tag.sh
      - name: Determine Bintray repository package version
        # Sets environment variable $REPO_PACKAGE_VERSION
        run: ./internal-scripts/ci-cd/publish/determine-repo-package-version.sh

      - name: Commit files published to APT repo
        run: ./internal-scripts/ci-cd/publish/commit-published-packages.sh
        env:
          BINTRAY_API_USERNAME: ${{ secrets.BINTRAY_API_USERNAME }}
          BINTRAY_API_KEY: ${{ secrets.BINTRAY_API_KEY }}
          REPO_NAME: fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Commit files published to YUM repo
        run: ./internal-scripts/ci-cd/publish/commit-published-packages.sh
        env:
          BINTRAY_API_USERNAME: ${{ secrets.BINTRAY_API_USERNAME }}
          BINTRAY_API_KEY: ${{ secrets.BINTRAY_API_KEY }}
          REPO_NAME: fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}


  ### Test packages against test repos ###



  test_packages_against_test_centos_7_2_7_normal:
    name: 'Test Ruby packages against test repos [centos-7/2.7/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-7/2.7/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-7_2.7_normal
          path: mark

  test_packages_against_test_centos_7_2_7_jemalloc:
    name: 'Test Ruby packages against test repos [centos-7/2.7/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-7/2.7/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-7_2.7_jemalloc
          path: mark

  test_packages_against_test_centos_7_2_7_malloctrim:
    name: 'Test Ruby packages against test repos [centos-7/2.7/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-7/2.7/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-7_2.7_malloctrim
          path: mark

  test_packages_against_test_centos_7_2_6_normal:
    name: 'Test Ruby packages against test repos [centos-7/2.6/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-7/2.6/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-7_2.6_normal
          path: mark

  test_packages_against_test_centos_7_2_6_jemalloc:
    name: 'Test Ruby packages against test repos [centos-7/2.6/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-7/2.6/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-7_2.6_jemalloc
          path: mark

  test_packages_against_test_centos_7_2_6_malloctrim:
    name: 'Test Ruby packages against test repos [centos-7/2.6/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-7/2.6/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-7_2.6_malloctrim
          path: mark

  test_packages_against_test_centos_7_2_5_normal:
    name: 'Test Ruby packages against test repos [centos-7/2.5/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-7/2.5/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-7_2.5_normal
          path: mark

  test_packages_against_test_centos_7_2_5_jemalloc:
    name: 'Test Ruby packages against test repos [centos-7/2.5/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-7/2.5/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-7_2.5_jemalloc
          path: mark

  test_packages_against_test_centos_7_2_5_malloctrim:
    name: 'Test Ruby packages against test repos [centos-7/2.5/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-7/2.5/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-7_2.5_malloctrim
          path: mark

  test_packages_against_test_centos_7_2_7_1_normal:
    name: 'Test Ruby packages against test repos [centos-7/2.7.1/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-7/2.7.1/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-7_2.7.1_normal
          path: mark

  test_packages_against_test_centos_7_2_7_1_jemalloc:
    name: 'Test Ruby packages against test repos [centos-7/2.7.1/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-7/2.7.1/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-7_2.7.1_jemalloc
          path: mark

  test_packages_against_test_centos_7_2_7_1_malloctrim:
    name: 'Test Ruby packages against test repos [centos-7/2.7.1/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-7/2.7.1/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-7_2.7.1_malloctrim
          path: mark

  test_packages_against_test_centos_7_2_6_6_normal:
    name: 'Test Ruby packages against test repos [centos-7/2.6.6/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-7/2.6.6/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-7_2.6.6_normal
          path: mark

  test_packages_against_test_centos_7_2_6_6_jemalloc:
    name: 'Test Ruby packages against test repos [centos-7/2.6.6/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-7/2.6.6/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-7_2.6.6_jemalloc
          path: mark

  test_packages_against_test_centos_7_2_6_6_malloctrim:
    name: 'Test Ruby packages against test repos [centos-7/2.6.6/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-7/2.6.6/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-7_2.6.6_malloctrim
          path: mark

  test_packages_against_test_centos_7_2_5_8_normal:
    name: 'Test Ruby packages against test repos [centos-7/2.5.8/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-7/2.5.8/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-7_2.5.8_normal
          path: mark

  test_packages_against_test_centos_7_2_5_8_jemalloc:
    name: 'Test Ruby packages against test repos [centos-7/2.5.8/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-7/2.5.8/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-7_2.5.8_jemalloc
          path: mark

  test_packages_against_test_centos_7_2_5_8_malloctrim:
    name: 'Test Ruby packages against test repos [centos-7/2.5.8/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-7/2.5.8/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-7_2.5.8_malloctrim
          path: mark


  test_packages_against_test_centos_8_2_7_normal:
    name: 'Test Ruby packages against test repos [centos-8/2.7/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-8/2.7/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-8_2.7_normal
          path: mark

  test_packages_against_test_centos_8_2_7_jemalloc:
    name: 'Test Ruby packages against test repos [centos-8/2.7/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-8/2.7/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-8_2.7_jemalloc
          path: mark

  test_packages_against_test_centos_8_2_7_malloctrim:
    name: 'Test Ruby packages against test repos [centos-8/2.7/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-8/2.7/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-8_2.7_malloctrim
          path: mark

  test_packages_against_test_centos_8_2_6_normal:
    name: 'Test Ruby packages against test repos [centos-8/2.6/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-8/2.6/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-8_2.6_normal
          path: mark

  test_packages_against_test_centos_8_2_6_jemalloc:
    name: 'Test Ruby packages against test repos [centos-8/2.6/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-8/2.6/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-8_2.6_jemalloc
          path: mark

  test_packages_against_test_centos_8_2_6_malloctrim:
    name: 'Test Ruby packages against test repos [centos-8/2.6/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-8/2.6/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-8_2.6_malloctrim
          path: mark

  test_packages_against_test_centos_8_2_5_normal:
    name: 'Test Ruby packages against test repos [centos-8/2.5/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-8/2.5/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-8_2.5_normal
          path: mark

  test_packages_against_test_centos_8_2_5_jemalloc:
    name: 'Test Ruby packages against test repos [centos-8/2.5/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-8/2.5/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-8_2.5_jemalloc
          path: mark

  test_packages_against_test_centos_8_2_5_malloctrim:
    name: 'Test Ruby packages against test repos [centos-8/2.5/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-8/2.5/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-8_2.5_malloctrim
          path: mark

  test_packages_against_test_centos_8_2_7_1_normal:
    name: 'Test Ruby packages against test repos [centos-8/2.7.1/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-8/2.7.1/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-8_2.7.1_normal
          path: mark

  test_packages_against_test_centos_8_2_7_1_jemalloc:
    name: 'Test Ruby packages against test repos [centos-8/2.7.1/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-8/2.7.1/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-8_2.7.1_jemalloc
          path: mark

  test_packages_against_test_centos_8_2_7_1_malloctrim:
    name: 'Test Ruby packages against test repos [centos-8/2.7.1/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-8/2.7.1/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-8_2.7.1_malloctrim
          path: mark

  test_packages_against_test_centos_8_2_6_6_normal:
    name: 'Test Ruby packages against test repos [centos-8/2.6.6/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-8/2.6.6/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-8_2.6.6_normal
          path: mark

  test_packages_against_test_centos_8_2_6_6_jemalloc:
    name: 'Test Ruby packages against test repos [centos-8/2.6.6/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-8/2.6.6/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-8_2.6.6_jemalloc
          path: mark

  test_packages_against_test_centos_8_2_6_6_malloctrim:
    name: 'Test Ruby packages against test repos [centos-8/2.6.6/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-8/2.6.6/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-8_2.6.6_malloctrim
          path: mark

  test_packages_against_test_centos_8_2_5_8_normal:
    name: 'Test Ruby packages against test repos [centos-8/2.5.8/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-8/2.5.8/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-8_2.5.8_normal
          path: mark

  test_packages_against_test_centos_8_2_5_8_jemalloc:
    name: 'Test Ruby packages against test repos [centos-8/2.5.8/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-8/2.5.8/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-8_2.5.8_jemalloc
          path: mark

  test_packages_against_test_centos_8_2_5_8_malloctrim:
    name: 'Test Ruby packages against test repos [centos-8/2.5.8/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [centos-8/2.5.8/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-centos-8_2.5.8_malloctrim
          path: mark


  test_packages_against_test_debian_10_2_7_normal:
    name: 'Test Ruby packages against test repos [debian-10/2.7/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-10/2.7/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-10_2.7_normal
          path: mark

  test_packages_against_test_debian_10_2_7_jemalloc:
    name: 'Test Ruby packages against test repos [debian-10/2.7/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-10/2.7/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-10_2.7_jemalloc
          path: mark

  test_packages_against_test_debian_10_2_7_malloctrim:
    name: 'Test Ruby packages against test repos [debian-10/2.7/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-10/2.7/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-10_2.7_malloctrim
          path: mark

  test_packages_against_test_debian_10_2_6_normal:
    name: 'Test Ruby packages against test repos [debian-10/2.6/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-10/2.6/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-10_2.6_normal
          path: mark

  test_packages_against_test_debian_10_2_6_jemalloc:
    name: 'Test Ruby packages against test repos [debian-10/2.6/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-10/2.6/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-10_2.6_jemalloc
          path: mark

  test_packages_against_test_debian_10_2_6_malloctrim:
    name: 'Test Ruby packages against test repos [debian-10/2.6/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-10/2.6/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-10_2.6_malloctrim
          path: mark

  test_packages_against_test_debian_10_2_5_normal:
    name: 'Test Ruby packages against test repos [debian-10/2.5/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-10/2.5/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-10_2.5_normal
          path: mark

  test_packages_against_test_debian_10_2_5_jemalloc:
    name: 'Test Ruby packages against test repos [debian-10/2.5/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-10/2.5/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-10_2.5_jemalloc
          path: mark

  test_packages_against_test_debian_10_2_5_malloctrim:
    name: 'Test Ruby packages against test repos [debian-10/2.5/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-10/2.5/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-10_2.5_malloctrim
          path: mark

  test_packages_against_test_debian_10_2_7_1_normal:
    name: 'Test Ruby packages against test repos [debian-10/2.7.1/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-10/2.7.1/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-10_2.7.1_normal
          path: mark

  test_packages_against_test_debian_10_2_7_1_jemalloc:
    name: 'Test Ruby packages against test repos [debian-10/2.7.1/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-10/2.7.1/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-10_2.7.1_jemalloc
          path: mark

  test_packages_against_test_debian_10_2_7_1_malloctrim:
    name: 'Test Ruby packages against test repos [debian-10/2.7.1/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-10/2.7.1/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-10_2.7.1_malloctrim
          path: mark

  test_packages_against_test_debian_10_2_6_6_normal:
    name: 'Test Ruby packages against test repos [debian-10/2.6.6/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-10/2.6.6/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-10_2.6.6_normal
          path: mark

  test_packages_against_test_debian_10_2_6_6_jemalloc:
    name: 'Test Ruby packages against test repos [debian-10/2.6.6/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-10/2.6.6/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-10_2.6.6_jemalloc
          path: mark

  test_packages_against_test_debian_10_2_6_6_malloctrim:
    name: 'Test Ruby packages against test repos [debian-10/2.6.6/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-10/2.6.6/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-10_2.6.6_malloctrim
          path: mark

  test_packages_against_test_debian_10_2_5_8_normal:
    name: 'Test Ruby packages against test repos [debian-10/2.5.8/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-10/2.5.8/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-10_2.5.8_normal
          path: mark

  test_packages_against_test_debian_10_2_5_8_jemalloc:
    name: 'Test Ruby packages against test repos [debian-10/2.5.8/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-10/2.5.8/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-10_2.5.8_jemalloc
          path: mark

  test_packages_against_test_debian_10_2_5_8_malloctrim:
    name: 'Test Ruby packages against test repos [debian-10/2.5.8/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-10/2.5.8/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-10_2.5.8_malloctrim
          path: mark


  test_packages_against_test_debian_9_2_7_normal:
    name: 'Test Ruby packages against test repos [debian-9/2.7/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-9/2.7/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-9_2.7_normal
          path: mark

  test_packages_against_test_debian_9_2_7_jemalloc:
    name: 'Test Ruby packages against test repos [debian-9/2.7/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-9/2.7/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-9_2.7_jemalloc
          path: mark

  test_packages_against_test_debian_9_2_7_malloctrim:
    name: 'Test Ruby packages against test repos [debian-9/2.7/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-9/2.7/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-9_2.7_malloctrim
          path: mark

  test_packages_against_test_debian_9_2_6_normal:
    name: 'Test Ruby packages against test repos [debian-9/2.6/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-9/2.6/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-9_2.6_normal
          path: mark

  test_packages_against_test_debian_9_2_6_jemalloc:
    name: 'Test Ruby packages against test repos [debian-9/2.6/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-9/2.6/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-9_2.6_jemalloc
          path: mark

  test_packages_against_test_debian_9_2_6_malloctrim:
    name: 'Test Ruby packages against test repos [debian-9/2.6/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-9/2.6/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-9_2.6_malloctrim
          path: mark

  test_packages_against_test_debian_9_2_5_normal:
    name: 'Test Ruby packages against test repos [debian-9/2.5/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-9/2.5/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-9_2.5_normal
          path: mark

  test_packages_against_test_debian_9_2_5_jemalloc:
    name: 'Test Ruby packages against test repos [debian-9/2.5/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-9/2.5/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-9_2.5_jemalloc
          path: mark

  test_packages_against_test_debian_9_2_5_malloctrim:
    name: 'Test Ruby packages against test repos [debian-9/2.5/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-9/2.5/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-9_2.5_malloctrim
          path: mark

  test_packages_against_test_debian_9_2_7_1_normal:
    name: 'Test Ruby packages against test repos [debian-9/2.7.1/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-9/2.7.1/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-9_2.7.1_normal
          path: mark

  test_packages_against_test_debian_9_2_7_1_jemalloc:
    name: 'Test Ruby packages against test repos [debian-9/2.7.1/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-9/2.7.1/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-9_2.7.1_jemalloc
          path: mark

  test_packages_against_test_debian_9_2_7_1_malloctrim:
    name: 'Test Ruby packages against test repos [debian-9/2.7.1/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-9/2.7.1/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-9_2.7.1_malloctrim
          path: mark

  test_packages_against_test_debian_9_2_6_6_normal:
    name: 'Test Ruby packages against test repos [debian-9/2.6.6/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-9/2.6.6/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-9_2.6.6_normal
          path: mark

  test_packages_against_test_debian_9_2_6_6_jemalloc:
    name: 'Test Ruby packages against test repos [debian-9/2.6.6/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-9/2.6.6/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-9_2.6.6_jemalloc
          path: mark

  test_packages_against_test_debian_9_2_6_6_malloctrim:
    name: 'Test Ruby packages against test repos [debian-9/2.6.6/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-9/2.6.6/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-9_2.6.6_malloctrim
          path: mark

  test_packages_against_test_debian_9_2_5_8_normal:
    name: 'Test Ruby packages against test repos [debian-9/2.5.8/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-9/2.5.8/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-9_2.5.8_normal
          path: mark

  test_packages_against_test_debian_9_2_5_8_jemalloc:
    name: 'Test Ruby packages against test repos [debian-9/2.5.8/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-9/2.5.8/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-9_2.5.8_jemalloc
          path: mark

  test_packages_against_test_debian_9_2_5_8_malloctrim:
    name: 'Test Ruby packages against test repos [debian-9/2.5.8/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [debian-9/2.5.8/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-debian-9_2.5.8_malloctrim
          path: mark


  test_packages_against_test_ubuntu_18_04_2_7_normal:
    name: 'Test Ruby packages against test repos [ubuntu-18.04/2.7/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-18.04/2.7/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-18.04_2.7_normal
          path: mark

  test_packages_against_test_ubuntu_18_04_2_7_jemalloc:
    name: 'Test Ruby packages against test repos [ubuntu-18.04/2.7/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-18.04/2.7/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-18.04_2.7_jemalloc
          path: mark

  test_packages_against_test_ubuntu_18_04_2_7_malloctrim:
    name: 'Test Ruby packages against test repos [ubuntu-18.04/2.7/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-18.04/2.7/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-18.04_2.7_malloctrim
          path: mark

  test_packages_against_test_ubuntu_18_04_2_6_normal:
    name: 'Test Ruby packages against test repos [ubuntu-18.04/2.6/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-18.04/2.6/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-18.04_2.6_normal
          path: mark

  test_packages_against_test_ubuntu_18_04_2_6_jemalloc:
    name: 'Test Ruby packages against test repos [ubuntu-18.04/2.6/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-18.04/2.6/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-18.04_2.6_jemalloc
          path: mark

  test_packages_against_test_ubuntu_18_04_2_6_malloctrim:
    name: 'Test Ruby packages against test repos [ubuntu-18.04/2.6/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-18.04/2.6/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-18.04_2.6_malloctrim
          path: mark

  test_packages_against_test_ubuntu_18_04_2_5_normal:
    name: 'Test Ruby packages against test repos [ubuntu-18.04/2.5/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-18.04/2.5/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-18.04_2.5_normal
          path: mark

  test_packages_against_test_ubuntu_18_04_2_5_jemalloc:
    name: 'Test Ruby packages against test repos [ubuntu-18.04/2.5/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-18.04/2.5/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-18.04_2.5_jemalloc
          path: mark

  test_packages_against_test_ubuntu_18_04_2_5_malloctrim:
    name: 'Test Ruby packages against test repos [ubuntu-18.04/2.5/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-18.04/2.5/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-18.04_2.5_malloctrim
          path: mark

  test_packages_against_test_ubuntu_18_04_2_7_1_normal:
    name: 'Test Ruby packages against test repos [ubuntu-18.04/2.7.1/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-18.04/2.7.1/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-18.04_2.7.1_normal
          path: mark

  test_packages_against_test_ubuntu_18_04_2_7_1_jemalloc:
    name: 'Test Ruby packages against test repos [ubuntu-18.04/2.7.1/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-18.04/2.7.1/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-18.04_2.7.1_jemalloc
          path: mark

  test_packages_against_test_ubuntu_18_04_2_7_1_malloctrim:
    name: 'Test Ruby packages against test repos [ubuntu-18.04/2.7.1/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-18.04/2.7.1/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-18.04_2.7.1_malloctrim
          path: mark

  test_packages_against_test_ubuntu_18_04_2_6_6_normal:
    name: 'Test Ruby packages against test repos [ubuntu-18.04/2.6.6/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-18.04/2.6.6/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-18.04_2.6.6_normal
          path: mark

  test_packages_against_test_ubuntu_18_04_2_6_6_jemalloc:
    name: 'Test Ruby packages against test repos [ubuntu-18.04/2.6.6/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-18.04/2.6.6/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-18.04_2.6.6_jemalloc
          path: mark

  test_packages_against_test_ubuntu_18_04_2_6_6_malloctrim:
    name: 'Test Ruby packages against test repos [ubuntu-18.04/2.6.6/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-18.04/2.6.6/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-18.04_2.6.6_malloctrim
          path: mark

  test_packages_against_test_ubuntu_18_04_2_5_8_normal:
    name: 'Test Ruby packages against test repos [ubuntu-18.04/2.5.8/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-18.04/2.5.8/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-18.04_2.5.8_normal
          path: mark

  test_packages_against_test_ubuntu_18_04_2_5_8_jemalloc:
    name: 'Test Ruby packages against test repos [ubuntu-18.04/2.5.8/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-18.04/2.5.8/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-18.04_2.5.8_jemalloc
          path: mark

  test_packages_against_test_ubuntu_18_04_2_5_8_malloctrim:
    name: 'Test Ruby packages against test repos [ubuntu-18.04/2.5.8/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-18.04/2.5.8/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-18.04_2.5.8_malloctrim
          path: mark


  test_packages_against_test_ubuntu_20_04_2_7_normal:
    name: 'Test Ruby packages against test repos [ubuntu-20.04/2.7/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-20.04/2.7/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-20.04_2.7_normal
          path: mark

  test_packages_against_test_ubuntu_20_04_2_7_jemalloc:
    name: 'Test Ruby packages against test repos [ubuntu-20.04/2.7/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-20.04/2.7/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-20.04_2.7_jemalloc
          path: mark

  test_packages_against_test_ubuntu_20_04_2_7_malloctrim:
    name: 'Test Ruby packages against test repos [ubuntu-20.04/2.7/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-20.04/2.7/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-20.04_2.7_malloctrim
          path: mark

  test_packages_against_test_ubuntu_20_04_2_6_normal:
    name: 'Test Ruby packages against test repos [ubuntu-20.04/2.6/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-20.04/2.6/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-20.04_2.6_normal
          path: mark

  test_packages_against_test_ubuntu_20_04_2_6_jemalloc:
    name: 'Test Ruby packages against test repos [ubuntu-20.04/2.6/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-20.04/2.6/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-20.04_2.6_jemalloc
          path: mark

  test_packages_against_test_ubuntu_20_04_2_6_malloctrim:
    name: 'Test Ruby packages against test repos [ubuntu-20.04/2.6/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-20.04/2.6/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-20.04_2.6_malloctrim
          path: mark

  test_packages_against_test_ubuntu_20_04_2_5_normal:
    name: 'Test Ruby packages against test repos [ubuntu-20.04/2.5/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-20.04/2.5/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-20.04_2.5_normal
          path: mark

  test_packages_against_test_ubuntu_20_04_2_5_jemalloc:
    name: 'Test Ruby packages against test repos [ubuntu-20.04/2.5/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-20.04/2.5/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-20.04_2.5_jemalloc
          path: mark

  test_packages_against_test_ubuntu_20_04_2_5_malloctrim:
    name: 'Test Ruby packages against test repos [ubuntu-20.04/2.5/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-20.04/2.5/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-20.04_2.5_malloctrim
          path: mark

  test_packages_against_test_ubuntu_20_04_2_7_1_normal:
    name: 'Test Ruby packages against test repos [ubuntu-20.04/2.7.1/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-20.04/2.7.1/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-20.04_2.7.1_normal
          path: mark

  test_packages_against_test_ubuntu_20_04_2_7_1_jemalloc:
    name: 'Test Ruby packages against test repos [ubuntu-20.04/2.7.1/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-20.04/2.7.1/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-20.04_2.7.1_jemalloc
          path: mark

  test_packages_against_test_ubuntu_20_04_2_7_1_malloctrim:
    name: 'Test Ruby packages against test repos [ubuntu-20.04/2.7.1/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-20.04/2.7.1/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-20.04_2.7.1_malloctrim
          path: mark

  test_packages_against_test_ubuntu_20_04_2_6_6_normal:
    name: 'Test Ruby packages against test repos [ubuntu-20.04/2.6.6/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-20.04/2.6.6/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-20.04_2.6.6_normal
          path: mark

  test_packages_against_test_ubuntu_20_04_2_6_6_jemalloc:
    name: 'Test Ruby packages against test repos [ubuntu-20.04/2.6.6/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-20.04/2.6.6/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-20.04_2.6.6_jemalloc
          path: mark

  test_packages_against_test_ubuntu_20_04_2_6_6_malloctrim:
    name: 'Test Ruby packages against test repos [ubuntu-20.04/2.6.6/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-20.04/2.6.6/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-20.04_2.6.6_malloctrim
          path: mark

  test_packages_against_test_ubuntu_20_04_2_5_8_normal:
    name: 'Test Ruby packages against test repos [ubuntu-20.04/2.5.8/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-20.04/2.5.8/normal];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-20.04_2.5.8_normal
          path: mark

  test_packages_against_test_ubuntu_20_04_2_5_8_jemalloc:
    name: 'Test Ruby packages against test repos [ubuntu-20.04/2.5.8/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-20.04/2.5.8/jemalloc];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-20.04_2.5.8_jemalloc
          path: mark

  test_packages_against_test_ubuntu_20_04_2_5_8_malloctrim:
    name: 'Test Ruby packages against test repos [ubuntu-20.04/2.5.8/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test

    if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against test repo [ubuntu-20.04/2.5.8/malloctrim];')
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ env.CI_ARTIFACTS_RUN_NUMBER }}

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-test-ubuntu-20.04_2.5.8_malloctrim
          path: mark



  ### Publish packages to production repo ###

  publish_packages_production:
    name: Publish packages to production repos
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - commit_published_packages_test
      - 'test_packages_against_test_centos_7_2_7_normal'
      - 'test_packages_against_test_centos_7_2_7_jemalloc'
      - 'test_packages_against_test_centos_7_2_7_malloctrim'
      - 'test_packages_against_test_centos_7_2_6_normal'
      - 'test_packages_against_test_centos_7_2_6_jemalloc'
      - 'test_packages_against_test_centos_7_2_6_malloctrim'
      - 'test_packages_against_test_centos_7_2_5_normal'
      - 'test_packages_against_test_centos_7_2_5_jemalloc'
      - 'test_packages_against_test_centos_7_2_5_malloctrim'
      - 'test_packages_against_test_centos_7_2_7_1_normal'
      - 'test_packages_against_test_centos_7_2_7_1_jemalloc'
      - 'test_packages_against_test_centos_7_2_7_1_malloctrim'
      - 'test_packages_against_test_centos_7_2_6_6_normal'
      - 'test_packages_against_test_centos_7_2_6_6_jemalloc'
      - 'test_packages_against_test_centos_7_2_6_6_malloctrim'
      - 'test_packages_against_test_centos_7_2_5_8_normal'
      - 'test_packages_against_test_centos_7_2_5_8_jemalloc'
      - 'test_packages_against_test_centos_7_2_5_8_malloctrim'
      - 'test_packages_against_test_centos_8_2_7_normal'
      - 'test_packages_against_test_centos_8_2_7_jemalloc'
      - 'test_packages_against_test_centos_8_2_7_malloctrim'
      - 'test_packages_against_test_centos_8_2_6_normal'
      - 'test_packages_against_test_centos_8_2_6_jemalloc'
      - 'test_packages_against_test_centos_8_2_6_malloctrim'
      - 'test_packages_against_test_centos_8_2_5_normal'
      - 'test_packages_against_test_centos_8_2_5_jemalloc'
      - 'test_packages_against_test_centos_8_2_5_malloctrim'
      - 'test_packages_against_test_centos_8_2_7_1_normal'
      - 'test_packages_against_test_centos_8_2_7_1_jemalloc'
      - 'test_packages_against_test_centos_8_2_7_1_malloctrim'
      - 'test_packages_against_test_centos_8_2_6_6_normal'
      - 'test_packages_against_test_centos_8_2_6_6_jemalloc'
      - 'test_packages_against_test_centos_8_2_6_6_malloctrim'
      - 'test_packages_against_test_centos_8_2_5_8_normal'
      - 'test_packages_against_test_centos_8_2_5_8_jemalloc'
      - 'test_packages_against_test_centos_8_2_5_8_malloctrim'
      - 'test_packages_against_test_debian_10_2_7_normal'
      - 'test_packages_against_test_debian_10_2_7_jemalloc'
      - 'test_packages_against_test_debian_10_2_7_malloctrim'
      - 'test_packages_against_test_debian_10_2_6_normal'
      - 'test_packages_against_test_debian_10_2_6_jemalloc'
      - 'test_packages_against_test_debian_10_2_6_malloctrim'
      - 'test_packages_against_test_debian_10_2_5_normal'
      - 'test_packages_against_test_debian_10_2_5_jemalloc'
      - 'test_packages_against_test_debian_10_2_5_malloctrim'
      - 'test_packages_against_test_debian_10_2_7_1_normal'
      - 'test_packages_against_test_debian_10_2_7_1_jemalloc'
      - 'test_packages_against_test_debian_10_2_7_1_malloctrim'
      - 'test_packages_against_test_debian_10_2_6_6_normal'
      - 'test_packages_against_test_debian_10_2_6_6_jemalloc'
      - 'test_packages_against_test_debian_10_2_6_6_malloctrim'
      - 'test_packages_against_test_debian_10_2_5_8_normal'
      - 'test_packages_against_test_debian_10_2_5_8_jemalloc'
      - 'test_packages_against_test_debian_10_2_5_8_malloctrim'
      - 'test_packages_against_test_debian_9_2_7_normal'
      - 'test_packages_against_test_debian_9_2_7_jemalloc'
      - 'test_packages_against_test_debian_9_2_7_malloctrim'
      - 'test_packages_against_test_debian_9_2_6_normal'
      - 'test_packages_against_test_debian_9_2_6_jemalloc'
      - 'test_packages_against_test_debian_9_2_6_malloctrim'
      - 'test_packages_against_test_debian_9_2_5_normal'
      - 'test_packages_against_test_debian_9_2_5_jemalloc'
      - 'test_packages_against_test_debian_9_2_5_malloctrim'
      - 'test_packages_against_test_debian_9_2_7_1_normal'
      - 'test_packages_against_test_debian_9_2_7_1_jemalloc'
      - 'test_packages_against_test_debian_9_2_7_1_malloctrim'
      - 'test_packages_against_test_debian_9_2_6_6_normal'
      - 'test_packages_against_test_debian_9_2_6_6_jemalloc'
      - 'test_packages_against_test_debian_9_2_6_6_malloctrim'
      - 'test_packages_against_test_debian_9_2_5_8_normal'
      - 'test_packages_against_test_debian_9_2_5_8_jemalloc'
      - 'test_packages_against_test_debian_9_2_5_8_malloctrim'
      - 'test_packages_against_test_ubuntu_18_04_2_7_normal'
      - 'test_packages_against_test_ubuntu_18_04_2_7_jemalloc'
      - 'test_packages_against_test_ubuntu_18_04_2_7_malloctrim'
      - 'test_packages_against_test_ubuntu_18_04_2_6_normal'
      - 'test_packages_against_test_ubuntu_18_04_2_6_jemalloc'
      - 'test_packages_against_test_ubuntu_18_04_2_6_malloctrim'
      - 'test_packages_against_test_ubuntu_18_04_2_5_normal'
      - 'test_packages_against_test_ubuntu_18_04_2_5_jemalloc'
      - 'test_packages_against_test_ubuntu_18_04_2_5_malloctrim'
      - 'test_packages_against_test_ubuntu_18_04_2_7_1_normal'
      - 'test_packages_against_test_ubuntu_18_04_2_7_1_jemalloc'
      - 'test_packages_against_test_ubuntu_18_04_2_7_1_malloctrim'
      - 'test_packages_against_test_ubuntu_18_04_2_6_6_normal'
      - 'test_packages_against_test_ubuntu_18_04_2_6_6_jemalloc'
      - 'test_packages_against_test_ubuntu_18_04_2_6_6_malloctrim'
      - 'test_packages_against_test_ubuntu_18_04_2_5_8_normal'
      - 'test_packages_against_test_ubuntu_18_04_2_5_8_jemalloc'
      - 'test_packages_against_test_ubuntu_18_04_2_5_8_malloctrim'
      - 'test_packages_against_test_ubuntu_20_04_2_7_normal'
      - 'test_packages_against_test_ubuntu_20_04_2_7_jemalloc'
      - 'test_packages_against_test_ubuntu_20_04_2_7_malloctrim'
      - 'test_packages_against_test_ubuntu_20_04_2_6_normal'
      - 'test_packages_against_test_ubuntu_20_04_2_6_jemalloc'
      - 'test_packages_against_test_ubuntu_20_04_2_6_malloctrim'
      - 'test_packages_against_test_ubuntu_20_04_2_5_normal'
      - 'test_packages_against_test_ubuntu_20_04_2_5_jemalloc'
      - 'test_packages_against_test_ubuntu_20_04_2_5_malloctrim'
      - 'test_packages_against_test_ubuntu_20_04_2_7_1_normal'
      - 'test_packages_against_test_ubuntu_20_04_2_7_1_jemalloc'
      - 'test_packages_against_test_ubuntu_20_04_2_7_1_malloctrim'
      - 'test_packages_against_test_ubuntu_20_04_2_6_6_normal'
      - 'test_packages_against_test_ubuntu_20_04_2_6_6_jemalloc'
      - 'test_packages_against_test_ubuntu_20_04_2_6_6_malloctrim'
      - 'test_packages_against_test_ubuntu_20_04_2_5_8_normal'
      - 'test_packages_against_test_ubuntu_20_04_2_5_8_jemalloc'
      - 'test_packages_against_test_ubuntu_20_04_2_5_8_malloctrim'
    # We don't care whether any 'Test packages against test' jobs
    # have been skipped. We only care whether 'Commit packages to
    # test repo' has been skipped, because that indicates a failure
    # in one of its transitive dependencies (e.g. 'Build Ruby').
    if: |
      needs.commit_published_packages_test.result == 'success'
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}

      - name: Download fullstaq-common DEB
        uses: ./.github/actions/download-artifact
        with:
          name: common-deb
          path: .
      - name: Download fullstaq-common RPM
        uses: ./.github/actions/download-artifact
        with:
          name: common-rpm
          path: .
      - name: Download Rbenv DEB
        uses: ./.github/actions/download-artifact
        with:
          name: rbenv-deb
          path: .
      - name: Download Rbenv RPM
        uses: ./.github/actions/download-artifact
        with:
          name: rbenv-rpm
          path: .


      - name: Fetch ruby-pkg_2.7_centos-7_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_centos-7_normal
          path: .
      - name: Fetch ruby-pkg_2.7_centos-7_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_centos-7_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.7_centos-7_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_centos-7_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.7_centos-8_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_centos-8_normal
          path: .
      - name: Fetch ruby-pkg_2.7_centos-8_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_centos-8_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.7_centos-8_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_centos-8_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.7_debian-10_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_debian-10_normal
          path: .
      - name: Fetch ruby-pkg_2.7_debian-10_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_debian-10_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.7_debian-10_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_debian-10_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.7_debian-9_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_debian-9_normal
          path: .
      - name: Fetch ruby-pkg_2.7_debian-9_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_debian-9_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.7_debian-9_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_debian-9_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.7_ubuntu-18.04_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_ubuntu-18.04_normal
          path: .
      - name: Fetch ruby-pkg_2.7_ubuntu-18.04_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_ubuntu-18.04_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.7_ubuntu-18.04_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_ubuntu-18.04_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.7_ubuntu-20.04_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_ubuntu-20.04_normal
          path: .
      - name: Fetch ruby-pkg_2.7_ubuntu-20.04_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_ubuntu-20.04_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.7_ubuntu-20.04_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7_ubuntu-20.04_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.6_centos-7_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_centos-7_normal
          path: .
      - name: Fetch ruby-pkg_2.6_centos-7_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_centos-7_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.6_centos-7_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_centos-7_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.6_centos-8_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_centos-8_normal
          path: .
      - name: Fetch ruby-pkg_2.6_centos-8_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_centos-8_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.6_centos-8_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_centos-8_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.6_debian-10_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_debian-10_normal
          path: .
      - name: Fetch ruby-pkg_2.6_debian-10_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_debian-10_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.6_debian-10_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_debian-10_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.6_debian-9_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_debian-9_normal
          path: .
      - name: Fetch ruby-pkg_2.6_debian-9_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_debian-9_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.6_debian-9_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_debian-9_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.6_ubuntu-18.04_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_ubuntu-18.04_normal
          path: .
      - name: Fetch ruby-pkg_2.6_ubuntu-18.04_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_ubuntu-18.04_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.6_ubuntu-18.04_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_ubuntu-18.04_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.6_ubuntu-20.04_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_ubuntu-20.04_normal
          path: .
      - name: Fetch ruby-pkg_2.6_ubuntu-20.04_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_ubuntu-20.04_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.6_ubuntu-20.04_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6_ubuntu-20.04_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.5_centos-7_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_centos-7_normal
          path: .
      - name: Fetch ruby-pkg_2.5_centos-7_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_centos-7_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.5_centos-7_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_centos-7_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.5_centos-8_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_centos-8_normal
          path: .
      - name: Fetch ruby-pkg_2.5_centos-8_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_centos-8_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.5_centos-8_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_centos-8_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.5_debian-10_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_debian-10_normal
          path: .
      - name: Fetch ruby-pkg_2.5_debian-10_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_debian-10_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.5_debian-10_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_debian-10_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.5_debian-9_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_debian-9_normal
          path: .
      - name: Fetch ruby-pkg_2.5_debian-9_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_debian-9_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.5_debian-9_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_debian-9_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.5_ubuntu-18.04_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_ubuntu-18.04_normal
          path: .
      - name: Fetch ruby-pkg_2.5_ubuntu-18.04_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_ubuntu-18.04_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.5_ubuntu-18.04_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_ubuntu-18.04_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.5_ubuntu-20.04_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_ubuntu-20.04_normal
          path: .
      - name: Fetch ruby-pkg_2.5_ubuntu-20.04_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_ubuntu-20.04_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.5_ubuntu-20.04_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5_ubuntu-20.04_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.7.1_centos-7_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_centos-7_normal
          path: .
      - name: Fetch ruby-pkg_2.7.1_centos-7_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_centos-7_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.7.1_centos-7_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_centos-7_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.7.1_centos-8_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_centos-8_normal
          path: .
      - name: Fetch ruby-pkg_2.7.1_centos-8_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_centos-8_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.7.1_centos-8_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_centos-8_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.7.1_debian-10_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_debian-10_normal
          path: .
      - name: Fetch ruby-pkg_2.7.1_debian-10_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_debian-10_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.7.1_debian-10_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_debian-10_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.7.1_debian-9_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_debian-9_normal
          path: .
      - name: Fetch ruby-pkg_2.7.1_debian-9_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_debian-9_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.7.1_debian-9_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_debian-9_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.7.1_ubuntu-18.04_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_ubuntu-18.04_normal
          path: .
      - name: Fetch ruby-pkg_2.7.1_ubuntu-18.04_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_ubuntu-18.04_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.7.1_ubuntu-18.04_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_ubuntu-18.04_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.7.1_ubuntu-20.04_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_ubuntu-20.04_normal
          path: .
      - name: Fetch ruby-pkg_2.7.1_ubuntu-20.04_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_ubuntu-20.04_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.7.1_ubuntu-20.04_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.7.1_ubuntu-20.04_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.6.6_centos-7_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_centos-7_normal
          path: .
      - name: Fetch ruby-pkg_2.6.6_centos-7_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_centos-7_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.6.6_centos-7_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_centos-7_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.6.6_centos-8_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_centos-8_normal
          path: .
      - name: Fetch ruby-pkg_2.6.6_centos-8_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_centos-8_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.6.6_centos-8_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_centos-8_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.6.6_debian-10_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_debian-10_normal
          path: .
      - name: Fetch ruby-pkg_2.6.6_debian-10_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_debian-10_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.6.6_debian-10_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_debian-10_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.6.6_debian-9_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_debian-9_normal
          path: .
      - name: Fetch ruby-pkg_2.6.6_debian-9_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_debian-9_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.6.6_debian-9_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_debian-9_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.6.6_ubuntu-18.04_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_ubuntu-18.04_normal
          path: .
      - name: Fetch ruby-pkg_2.6.6_ubuntu-18.04_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_ubuntu-18.04_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.6.6_ubuntu-18.04_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_ubuntu-18.04_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.6.6_ubuntu-20.04_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_ubuntu-20.04_normal
          path: .
      - name: Fetch ruby-pkg_2.6.6_ubuntu-20.04_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_ubuntu-20.04_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.6.6_ubuntu-20.04_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.6.6_ubuntu-20.04_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.5.8_centos-7_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_centos-7_normal
          path: .
      - name: Fetch ruby-pkg_2.5.8_centos-7_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_centos-7_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.5.8_centos-7_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_centos-7_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.5.8_centos-8_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_centos-8_normal
          path: .
      - name: Fetch ruby-pkg_2.5.8_centos-8_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_centos-8_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.5.8_centos-8_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_centos-8_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.5.8_debian-10_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_debian-10_normal
          path: .
      - name: Fetch ruby-pkg_2.5.8_debian-10_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_debian-10_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.5.8_debian-10_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_debian-10_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.5.8_debian-9_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_debian-9_normal
          path: .
      - name: Fetch ruby-pkg_2.5.8_debian-9_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_debian-9_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.5.8_debian-9_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_debian-9_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.5.8_ubuntu-18.04_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_ubuntu-18.04_normal
          path: .
      - name: Fetch ruby-pkg_2.5.8_ubuntu-18.04_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_ubuntu-18.04_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.5.8_ubuntu-18.04_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_ubuntu-18.04_malloctrim
          path: .
      - name: Fetch ruby-pkg_2.5.8_ubuntu-20.04_normal
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_ubuntu-20.04_normal
          path: .
      - name: Fetch ruby-pkg_2.5.8_ubuntu-20.04_jemalloc
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_ubuntu-20.04_jemalloc
          path: .
      - name: Fetch ruby-pkg_2.5.8_ubuntu-20.04_malloctrim
        uses: ./.github/actions/download-artifact
        with:
          name: ruby-pkg_2.5.8_ubuntu-20.04_malloctrim
          path: .

      - name: Download Docker image necessary for publishing
        uses: ./.github/actions/download-artifact
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        with:
          name: docker-image-utility
          path: .
      - name: Load Docker image necessary for publishing
        run: ./internal-scripts/ci-cd/load-docker-image.sh
        if: contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Build Docker image utility;')
        env:
          TARBALL: image.tar.zst

      - name: Determine latest release tag
        # Sets environment variable $LATEST_RELEASE_TAG
        run: ./internal-scripts/ci-cd/check-version-numbers-need-changing/determine-latest-release-tag.sh
      - name: Determine Bintray repository package version
        # Sets environment variable $REPO_PACKAGE_VERSION
        run: ./internal-scripts/ci-cd/publish/determine-repo-package-version.sh

      - name: Upload DEBs to repo
        run: ./internal-scripts/ci-cd/publish/publish-debs.sh *.deb
        env:
          BINTRAY_API_USERNAME: ${{ secrets.BINTRAY_API_USERNAME }}
          BINTRAY_API_KEY: ${{ secrets.BINTRAY_API_KEY }}
          REPO_NAME: fullstaq-ruby-apt
          DRY_RUN: ${{ github.ref != 'refs/heads/main' }}
          IGNORE_EXISTING: true

      - name: Commit files published to APT repo
        run: ./internal-scripts/ci-cd/publish/commit-published-packages.sh
        env:
          BINTRAY_API_USERNAME: ${{ secrets.BINTRAY_API_USERNAME }}
          BINTRAY_API_KEY: ${{ secrets.BINTRAY_API_KEY }}
          REPO_NAME: fullstaq-ruby-apt

      - name: Upload RPMs to repo
        run: ./internal-scripts/ci-cd/publish/publish-rpms.sh *.rpm
        env:
          BINTRAY_API_USERNAME: ${{ secrets.BINTRAY_API_USERNAME }}
          BINTRAY_API_KEY: ${{ secrets.BINTRAY_API_KEY }}
          REPO_NAME: fullstaq-ruby-yum
          DRY_RUN: ${{ github.ref != 'refs/heads/main' }}
          IGNORE_EXISTING: true

      - name: Commit files published to YUM repo
        run: ./internal-scripts/ci-cd/publish/commit-published-packages.sh
        env:
          BINTRAY_API_USERNAME: ${{ secrets.BINTRAY_API_USERNAME }}
          BINTRAY_API_KEY: ${{ secrets.BINTRAY_API_KEY }}
          REPO_NAME: fullstaq-ruby-yum


  ### Test packages against production repos ###



  test_packages_against_production_centos_7_2_7_normal:
    name: 'Test Ruby packages against production repos [centos-7/2.7/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-7/2.7/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-7_2.7_normal
          path: mark

  test_packages_against_production_centos_7_2_7_jemalloc:
    name: 'Test Ruby packages against production repos [centos-7/2.7/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-7/2.7/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-7_2.7_jemalloc
          path: mark

  test_packages_against_production_centos_7_2_7_malloctrim:
    name: 'Test Ruby packages against production repos [centos-7/2.7/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-7/2.7/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-7_2.7_malloctrim
          path: mark

  test_packages_against_production_centos_7_2_6_normal:
    name: 'Test Ruby packages against production repos [centos-7/2.6/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-7/2.6/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-7_2.6_normal
          path: mark

  test_packages_against_production_centos_7_2_6_jemalloc:
    name: 'Test Ruby packages against production repos [centos-7/2.6/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-7/2.6/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-7_2.6_jemalloc
          path: mark

  test_packages_against_production_centos_7_2_6_malloctrim:
    name: 'Test Ruby packages against production repos [centos-7/2.6/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-7/2.6/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-7_2.6_malloctrim
          path: mark

  test_packages_against_production_centos_7_2_5_normal:
    name: 'Test Ruby packages against production repos [centos-7/2.5/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-7/2.5/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-7_2.5_normal
          path: mark

  test_packages_against_production_centos_7_2_5_jemalloc:
    name: 'Test Ruby packages against production repos [centos-7/2.5/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-7/2.5/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-7_2.5_jemalloc
          path: mark

  test_packages_against_production_centos_7_2_5_malloctrim:
    name: 'Test Ruby packages against production repos [centos-7/2.5/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-7/2.5/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-7_2.5_malloctrim
          path: mark

  test_packages_against_production_centos_7_2_7_1_normal:
    name: 'Test Ruby packages against production repos [centos-7/2.7.1/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-7/2.7.1/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-7_2.7.1_normal
          path: mark

  test_packages_against_production_centos_7_2_7_1_jemalloc:
    name: 'Test Ruby packages against production repos [centos-7/2.7.1/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-7/2.7.1/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-7_2.7.1_jemalloc
          path: mark

  test_packages_against_production_centos_7_2_7_1_malloctrim:
    name: 'Test Ruby packages against production repos [centos-7/2.7.1/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-7/2.7.1/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-7_2.7.1_malloctrim
          path: mark

  test_packages_against_production_centos_7_2_6_6_normal:
    name: 'Test Ruby packages against production repos [centos-7/2.6.6/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-7/2.6.6/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-7_2.6.6_normal
          path: mark

  test_packages_against_production_centos_7_2_6_6_jemalloc:
    name: 'Test Ruby packages against production repos [centos-7/2.6.6/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-7/2.6.6/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-7_2.6.6_jemalloc
          path: mark

  test_packages_against_production_centos_7_2_6_6_malloctrim:
    name: 'Test Ruby packages against production repos [centos-7/2.6.6/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-7/2.6.6/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-7_2.6.6_malloctrim
          path: mark

  test_packages_against_production_centos_7_2_5_8_normal:
    name: 'Test Ruby packages against production repos [centos-7/2.5.8/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-7/2.5.8/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-7_2.5.8_normal
          path: mark

  test_packages_against_production_centos_7_2_5_8_jemalloc:
    name: 'Test Ruby packages against production repos [centos-7/2.5.8/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-7/2.5.8/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-7_2.5.8_jemalloc
          path: mark

  test_packages_against_production_centos_7_2_5_8_malloctrim:
    name: 'Test Ruby packages against production repos [centos-7/2.5.8/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-7/2.5.8/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-7_2.5.8_malloctrim
          path: mark


  test_packages_against_production_centos_8_2_7_normal:
    name: 'Test Ruby packages against production repos [centos-8/2.7/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-8/2.7/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-8_2.7_normal
          path: mark

  test_packages_against_production_centos_8_2_7_jemalloc:
    name: 'Test Ruby packages against production repos [centos-8/2.7/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-8/2.7/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-8_2.7_jemalloc
          path: mark

  test_packages_against_production_centos_8_2_7_malloctrim:
    name: 'Test Ruby packages against production repos [centos-8/2.7/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-8/2.7/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-8_2.7_malloctrim
          path: mark

  test_packages_against_production_centos_8_2_6_normal:
    name: 'Test Ruby packages against production repos [centos-8/2.6/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-8/2.6/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-8_2.6_normal
          path: mark

  test_packages_against_production_centos_8_2_6_jemalloc:
    name: 'Test Ruby packages against production repos [centos-8/2.6/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-8/2.6/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-8_2.6_jemalloc
          path: mark

  test_packages_against_production_centos_8_2_6_malloctrim:
    name: 'Test Ruby packages against production repos [centos-8/2.6/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-8/2.6/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-8_2.6_malloctrim
          path: mark

  test_packages_against_production_centos_8_2_5_normal:
    name: 'Test Ruby packages against production repos [centos-8/2.5/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-8/2.5/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-8_2.5_normal
          path: mark

  test_packages_against_production_centos_8_2_5_jemalloc:
    name: 'Test Ruby packages against production repos [centos-8/2.5/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-8/2.5/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-8_2.5_jemalloc
          path: mark

  test_packages_against_production_centos_8_2_5_malloctrim:
    name: 'Test Ruby packages against production repos [centos-8/2.5/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-8/2.5/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-8_2.5_malloctrim
          path: mark

  test_packages_against_production_centos_8_2_7_1_normal:
    name: 'Test Ruby packages against production repos [centos-8/2.7.1/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-8/2.7.1/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-8_2.7.1_normal
          path: mark

  test_packages_against_production_centos_8_2_7_1_jemalloc:
    name: 'Test Ruby packages against production repos [centos-8/2.7.1/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-8/2.7.1/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-8_2.7.1_jemalloc
          path: mark

  test_packages_against_production_centos_8_2_7_1_malloctrim:
    name: 'Test Ruby packages against production repos [centos-8/2.7.1/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-8/2.7.1/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-8_2.7.1_malloctrim
          path: mark

  test_packages_against_production_centos_8_2_6_6_normal:
    name: 'Test Ruby packages against production repos [centos-8/2.6.6/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-8/2.6.6/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-8_2.6.6_normal
          path: mark

  test_packages_against_production_centos_8_2_6_6_jemalloc:
    name: 'Test Ruby packages against production repos [centos-8/2.6.6/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-8/2.6.6/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-8_2.6.6_jemalloc
          path: mark

  test_packages_against_production_centos_8_2_6_6_malloctrim:
    name: 'Test Ruby packages against production repos [centos-8/2.6.6/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-8/2.6.6/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-8_2.6.6_malloctrim
          path: mark

  test_packages_against_production_centos_8_2_5_8_normal:
    name: 'Test Ruby packages against production repos [centos-8/2.5.8/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-8/2.5.8/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-8_2.5.8_normal
          path: mark

  test_packages_against_production_centos_8_2_5_8_jemalloc:
    name: 'Test Ruby packages against production repos [centos-8/2.5.8/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-8/2.5.8/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-8_2.5.8_jemalloc
          path: mark

  test_packages_against_production_centos_8_2_5_8_malloctrim:
    name: 'Test Ruby packages against production repos [centos-8/2.5.8/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [centos-8/2.5.8/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-centos-8_2.5.8_malloctrim
          path: mark


  test_packages_against_production_debian_10_2_7_normal:
    name: 'Test Ruby packages against production repos [debian-10/2.7/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-10/2.7/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-10_2.7_normal
          path: mark

  test_packages_against_production_debian_10_2_7_jemalloc:
    name: 'Test Ruby packages against production repos [debian-10/2.7/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-10/2.7/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-10_2.7_jemalloc
          path: mark

  test_packages_against_production_debian_10_2_7_malloctrim:
    name: 'Test Ruby packages against production repos [debian-10/2.7/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-10/2.7/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-10_2.7_malloctrim
          path: mark

  test_packages_against_production_debian_10_2_6_normal:
    name: 'Test Ruby packages against production repos [debian-10/2.6/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-10/2.6/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-10_2.6_normal
          path: mark

  test_packages_against_production_debian_10_2_6_jemalloc:
    name: 'Test Ruby packages against production repos [debian-10/2.6/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-10/2.6/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-10_2.6_jemalloc
          path: mark

  test_packages_against_production_debian_10_2_6_malloctrim:
    name: 'Test Ruby packages against production repos [debian-10/2.6/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-10/2.6/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-10_2.6_malloctrim
          path: mark

  test_packages_against_production_debian_10_2_5_normal:
    name: 'Test Ruby packages against production repos [debian-10/2.5/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-10/2.5/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-10_2.5_normal
          path: mark

  test_packages_against_production_debian_10_2_5_jemalloc:
    name: 'Test Ruby packages against production repos [debian-10/2.5/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-10/2.5/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-10_2.5_jemalloc
          path: mark

  test_packages_against_production_debian_10_2_5_malloctrim:
    name: 'Test Ruby packages against production repos [debian-10/2.5/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-10/2.5/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-10_2.5_malloctrim
          path: mark

  test_packages_against_production_debian_10_2_7_1_normal:
    name: 'Test Ruby packages against production repos [debian-10/2.7.1/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-10/2.7.1/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-10_2.7.1_normal
          path: mark

  test_packages_against_production_debian_10_2_7_1_jemalloc:
    name: 'Test Ruby packages against production repos [debian-10/2.7.1/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-10/2.7.1/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-10_2.7.1_jemalloc
          path: mark

  test_packages_against_production_debian_10_2_7_1_malloctrim:
    name: 'Test Ruby packages against production repos [debian-10/2.7.1/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-10/2.7.1/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-10_2.7.1_malloctrim
          path: mark

  test_packages_against_production_debian_10_2_6_6_normal:
    name: 'Test Ruby packages against production repos [debian-10/2.6.6/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-10/2.6.6/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-10_2.6.6_normal
          path: mark

  test_packages_against_production_debian_10_2_6_6_jemalloc:
    name: 'Test Ruby packages against production repos [debian-10/2.6.6/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-10/2.6.6/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-10_2.6.6_jemalloc
          path: mark

  test_packages_against_production_debian_10_2_6_6_malloctrim:
    name: 'Test Ruby packages against production repos [debian-10/2.6.6/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-10/2.6.6/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-10_2.6.6_malloctrim
          path: mark

  test_packages_against_production_debian_10_2_5_8_normal:
    name: 'Test Ruby packages against production repos [debian-10/2.5.8/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-10/2.5.8/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-10_2.5.8_normal
          path: mark

  test_packages_against_production_debian_10_2_5_8_jemalloc:
    name: 'Test Ruby packages against production repos [debian-10/2.5.8/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-10/2.5.8/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-10_2.5.8_jemalloc
          path: mark

  test_packages_against_production_debian_10_2_5_8_malloctrim:
    name: 'Test Ruby packages against production repos [debian-10/2.5.8/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-10/2.5.8/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-10_2.5.8_malloctrim
          path: mark


  test_packages_against_production_debian_9_2_7_normal:
    name: 'Test Ruby packages against production repos [debian-9/2.7/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-9/2.7/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-9_2.7_normal
          path: mark

  test_packages_against_production_debian_9_2_7_jemalloc:
    name: 'Test Ruby packages against production repos [debian-9/2.7/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-9/2.7/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-9_2.7_jemalloc
          path: mark

  test_packages_against_production_debian_9_2_7_malloctrim:
    name: 'Test Ruby packages against production repos [debian-9/2.7/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-9/2.7/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-9_2.7_malloctrim
          path: mark

  test_packages_against_production_debian_9_2_6_normal:
    name: 'Test Ruby packages against production repos [debian-9/2.6/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-9/2.6/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-9_2.6_normal
          path: mark

  test_packages_against_production_debian_9_2_6_jemalloc:
    name: 'Test Ruby packages against production repos [debian-9/2.6/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-9/2.6/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-9_2.6_jemalloc
          path: mark

  test_packages_against_production_debian_9_2_6_malloctrim:
    name: 'Test Ruby packages against production repos [debian-9/2.6/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-9/2.6/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-9_2.6_malloctrim
          path: mark

  test_packages_against_production_debian_9_2_5_normal:
    name: 'Test Ruby packages against production repos [debian-9/2.5/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-9/2.5/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-9_2.5_normal
          path: mark

  test_packages_against_production_debian_9_2_5_jemalloc:
    name: 'Test Ruby packages against production repos [debian-9/2.5/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-9/2.5/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-9_2.5_jemalloc
          path: mark

  test_packages_against_production_debian_9_2_5_malloctrim:
    name: 'Test Ruby packages against production repos [debian-9/2.5/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-9/2.5/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-9_2.5_malloctrim
          path: mark

  test_packages_against_production_debian_9_2_7_1_normal:
    name: 'Test Ruby packages against production repos [debian-9/2.7.1/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-9/2.7.1/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-9_2.7.1_normal
          path: mark

  test_packages_against_production_debian_9_2_7_1_jemalloc:
    name: 'Test Ruby packages against production repos [debian-9/2.7.1/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-9/2.7.1/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-9_2.7.1_jemalloc
          path: mark

  test_packages_against_production_debian_9_2_7_1_malloctrim:
    name: 'Test Ruby packages against production repos [debian-9/2.7.1/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-9/2.7.1/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-9_2.7.1_malloctrim
          path: mark

  test_packages_against_production_debian_9_2_6_6_normal:
    name: 'Test Ruby packages against production repos [debian-9/2.6.6/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-9/2.6.6/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-9_2.6.6_normal
          path: mark

  test_packages_against_production_debian_9_2_6_6_jemalloc:
    name: 'Test Ruby packages against production repos [debian-9/2.6.6/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-9/2.6.6/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-9_2.6.6_jemalloc
          path: mark

  test_packages_against_production_debian_9_2_6_6_malloctrim:
    name: 'Test Ruby packages against production repos [debian-9/2.6.6/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-9/2.6.6/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-9_2.6.6_malloctrim
          path: mark

  test_packages_against_production_debian_9_2_5_8_normal:
    name: 'Test Ruby packages against production repos [debian-9/2.5.8/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-9/2.5.8/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-9_2.5.8_normal
          path: mark

  test_packages_against_production_debian_9_2_5_8_jemalloc:
    name: 'Test Ruby packages against production repos [debian-9/2.5.8/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-9/2.5.8/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-9_2.5.8_jemalloc
          path: mark

  test_packages_against_production_debian_9_2_5_8_malloctrim:
    name: 'Test Ruby packages against production repos [debian-9/2.5.8/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [debian-9/2.5.8/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-debian-9_2.5.8_malloctrim
          path: mark


  test_packages_against_production_ubuntu_18_04_2_7_normal:
    name: 'Test Ruby packages against production repos [ubuntu-18.04/2.7/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-18.04/2.7/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-18.04_2.7_normal
          path: mark

  test_packages_against_production_ubuntu_18_04_2_7_jemalloc:
    name: 'Test Ruby packages against production repos [ubuntu-18.04/2.7/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-18.04/2.7/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-18.04_2.7_jemalloc
          path: mark

  test_packages_against_production_ubuntu_18_04_2_7_malloctrim:
    name: 'Test Ruby packages against production repos [ubuntu-18.04/2.7/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-18.04/2.7/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-18.04_2.7_malloctrim
          path: mark

  test_packages_against_production_ubuntu_18_04_2_6_normal:
    name: 'Test Ruby packages against production repos [ubuntu-18.04/2.6/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-18.04/2.6/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-18.04_2.6_normal
          path: mark

  test_packages_against_production_ubuntu_18_04_2_6_jemalloc:
    name: 'Test Ruby packages against production repos [ubuntu-18.04/2.6/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-18.04/2.6/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-18.04_2.6_jemalloc
          path: mark

  test_packages_against_production_ubuntu_18_04_2_6_malloctrim:
    name: 'Test Ruby packages against production repos [ubuntu-18.04/2.6/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-18.04/2.6/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-18.04_2.6_malloctrim
          path: mark

  test_packages_against_production_ubuntu_18_04_2_5_normal:
    name: 'Test Ruby packages against production repos [ubuntu-18.04/2.5/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-18.04/2.5/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-18.04_2.5_normal
          path: mark

  test_packages_against_production_ubuntu_18_04_2_5_jemalloc:
    name: 'Test Ruby packages against production repos [ubuntu-18.04/2.5/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-18.04/2.5/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-18.04_2.5_jemalloc
          path: mark

  test_packages_against_production_ubuntu_18_04_2_5_malloctrim:
    name: 'Test Ruby packages against production repos [ubuntu-18.04/2.5/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-18.04/2.5/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-18.04_2.5_malloctrim
          path: mark

  test_packages_against_production_ubuntu_18_04_2_7_1_normal:
    name: 'Test Ruby packages against production repos [ubuntu-18.04/2.7.1/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-18.04/2.7.1/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-18.04_2.7.1_normal
          path: mark

  test_packages_against_production_ubuntu_18_04_2_7_1_jemalloc:
    name: 'Test Ruby packages against production repos [ubuntu-18.04/2.7.1/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-18.04/2.7.1/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-18.04_2.7.1_jemalloc
          path: mark

  test_packages_against_production_ubuntu_18_04_2_7_1_malloctrim:
    name: 'Test Ruby packages against production repos [ubuntu-18.04/2.7.1/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-18.04/2.7.1/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-18.04_2.7.1_malloctrim
          path: mark

  test_packages_against_production_ubuntu_18_04_2_6_6_normal:
    name: 'Test Ruby packages against production repos [ubuntu-18.04/2.6.6/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-18.04/2.6.6/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-18.04_2.6.6_normal
          path: mark

  test_packages_against_production_ubuntu_18_04_2_6_6_jemalloc:
    name: 'Test Ruby packages against production repos [ubuntu-18.04/2.6.6/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-18.04/2.6.6/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-18.04_2.6.6_jemalloc
          path: mark

  test_packages_against_production_ubuntu_18_04_2_6_6_malloctrim:
    name: 'Test Ruby packages against production repos [ubuntu-18.04/2.6.6/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-18.04/2.6.6/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-18.04_2.6.6_malloctrim
          path: mark

  test_packages_against_production_ubuntu_18_04_2_5_8_normal:
    name: 'Test Ruby packages against production repos [ubuntu-18.04/2.5.8/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-18.04/2.5.8/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-18.04_2.5.8_normal
          path: mark

  test_packages_against_production_ubuntu_18_04_2_5_8_jemalloc:
    name: 'Test Ruby packages against production repos [ubuntu-18.04/2.5.8/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-18.04/2.5.8/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-18.04_2.5.8_jemalloc
          path: mark

  test_packages_against_production_ubuntu_18_04_2_5_8_malloctrim:
    name: 'Test Ruby packages against production repos [ubuntu-18.04/2.5.8/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-18.04/2.5.8/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-18.04_2.5.8_malloctrim
          path: mark


  test_packages_against_production_ubuntu_20_04_2_7_normal:
    name: 'Test Ruby packages against production repos [ubuntu-20.04/2.7/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-20.04/2.7/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-20.04_2.7_normal
          path: mark

  test_packages_against_production_ubuntu_20_04_2_7_jemalloc:
    name: 'Test Ruby packages against production repos [ubuntu-20.04/2.7/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-20.04/2.7/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-20.04_2.7_jemalloc
          path: mark

  test_packages_against_production_ubuntu_20_04_2_7_malloctrim:
    name: 'Test Ruby packages against production repos [ubuntu-20.04/2.7/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-20.04/2.7/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.7"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-20.04_2.7_malloctrim
          path: mark

  test_packages_against_production_ubuntu_20_04_2_6_normal:
    name: 'Test Ruby packages against production repos [ubuntu-20.04/2.6/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-20.04/2.6/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-20.04_2.6_normal
          path: mark

  test_packages_against_production_ubuntu_20_04_2_6_jemalloc:
    name: 'Test Ruby packages against production repos [ubuntu-20.04/2.6/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-20.04/2.6/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-20.04_2.6_jemalloc
          path: mark

  test_packages_against_production_ubuntu_20_04_2_6_malloctrim:
    name: 'Test Ruby packages against production repos [ubuntu-20.04/2.6/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-20.04/2.6/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-20.04_2.6_malloctrim
          path: mark

  test_packages_against_production_ubuntu_20_04_2_5_normal:
    name: 'Test Ruby packages against production repos [ubuntu-20.04/2.5/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-20.04/2.5/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-20.04_2.5_normal
          path: mark

  test_packages_against_production_ubuntu_20_04_2_5_jemalloc:
    name: 'Test Ruby packages against production repos [ubuntu-20.04/2.5/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-20.04/2.5/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-20.04_2.5_jemalloc
          path: mark

  test_packages_against_production_ubuntu_20_04_2_5_malloctrim:
    name: 'Test Ruby packages against production repos [ubuntu-20.04/2.5/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-20.04/2.5/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.5"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-20.04_2.5_malloctrim
          path: mark

  test_packages_against_production_ubuntu_20_04_2_7_1_normal:
    name: 'Test Ruby packages against production repos [ubuntu-20.04/2.7.1/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-20.04/2.7.1/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-20.04_2.7.1_normal
          path: mark

  test_packages_against_production_ubuntu_20_04_2_7_1_jemalloc:
    name: 'Test Ruby packages against production repos [ubuntu-20.04/2.7.1/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-20.04/2.7.1/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-20.04_2.7.1_jemalloc
          path: mark

  test_packages_against_production_ubuntu_20_04_2_7_1_malloctrim:
    name: 'Test Ruby packages against production repos [ubuntu-20.04/2.7.1/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-20.04/2.7.1/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.7.1"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-20.04_2.7.1_malloctrim
          path: mark

  test_packages_against_production_ubuntu_20_04_2_6_6_normal:
    name: 'Test Ruby packages against production repos [ubuntu-20.04/2.6.6/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-20.04/2.6.6/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-20.04_2.6.6_normal
          path: mark

  test_packages_against_production_ubuntu_20_04_2_6_6_jemalloc:
    name: 'Test Ruby packages against production repos [ubuntu-20.04/2.6.6/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-20.04/2.6.6/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-20.04_2.6.6_jemalloc
          path: mark

  test_packages_against_production_ubuntu_20_04_2_6_6_malloctrim:
    name: 'Test Ruby packages against production repos [ubuntu-20.04/2.6.6/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-20.04/2.6.6/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.6.6"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-20.04_2.6.6_malloctrim
          path: mark

  test_packages_against_production_ubuntu_20_04_2_5_8_normal:
    name: 'Test Ruby packages against production repos [ubuntu-20.04/2.5.8/normal]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-20.04/2.5.8/normal];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "normal"
          VARIANT_PACKAGE_SUFFIX: ""
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-20.04_2.5.8_normal
          path: mark

  test_packages_against_production_ubuntu_20_04_2_5_8_jemalloc:
    name: 'Test Ruby packages against production repos [ubuntu-20.04/2.5.8/jemalloc]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-20.04/2.5.8/jemalloc];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "jemalloc"
          VARIANT_PACKAGE_SUFFIX: "-jemalloc"
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-20.04_2.5.8_jemalloc
          path: mark

  test_packages_against_production_ubuntu_20_04_2_5_8_malloctrim:
    name: 'Test Ruby packages against production repos [ubuntu-20.04/2.5.8/malloctrim]'
    runs-on: ubuntu-20.04
    needs:
      - determine_necessary_jobs
      - publish_packages_production
    if: |
      github.ref == 'refs/heads/main'
      && needs.publish_packages_production.result == 'success'
      && contains(needs.determine_necessary_jobs.outputs.necessary_jobs, ';Test against production repo [ubuntu-20.04/2.5.8/malloctrim];')
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-20.04"
          RUBY_PACKAGE_ID: "2.5.8"
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: "malloctrim"
          VARIANT_PACKAGE_SUFFIX: "-malloctrim"
          TEST_IMAGE_NAME: "ubuntu:20.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org

      - name: Login to Google Cloud
        uses: ./.github/actions/gcloud-login
        with:
          private_key: ${{ secrets.GCLOUD_KEY }}
      - name: Create mark file
        run: mkdir mark && touch mark/done.txt
      - name: Mark job as done
        uses: ./.github/actions/upload-artifact
        with:
          name: tested-against-production-ubuntu-20.04_2.5.8_malloctrim
          path: mark



  ### Create Git tag ###

  create_git_tag:
    name: Create Git tag
    runs-on: ubuntu-20.04
    needs:
      - publish_packages_production
      - 'test_packages_against_production_centos_7_2_7_normal'
      - 'test_packages_against_production_centos_7_2_7_jemalloc'
      - 'test_packages_against_production_centos_7_2_7_malloctrim'
      - 'test_packages_against_production_centos_7_2_6_normal'
      - 'test_packages_against_production_centos_7_2_6_jemalloc'
      - 'test_packages_against_production_centos_7_2_6_malloctrim'
      - 'test_packages_against_production_centos_7_2_5_normal'
      - 'test_packages_against_production_centos_7_2_5_jemalloc'
      - 'test_packages_against_production_centos_7_2_5_malloctrim'
      - 'test_packages_against_production_centos_7_2_7_1_normal'
      - 'test_packages_against_production_centos_7_2_7_1_jemalloc'
      - 'test_packages_against_production_centos_7_2_7_1_malloctrim'
      - 'test_packages_against_production_centos_7_2_6_6_normal'
      - 'test_packages_against_production_centos_7_2_6_6_jemalloc'
      - 'test_packages_against_production_centos_7_2_6_6_malloctrim'
      - 'test_packages_against_production_centos_7_2_5_8_normal'
      - 'test_packages_against_production_centos_7_2_5_8_jemalloc'
      - 'test_packages_against_production_centos_7_2_5_8_malloctrim'
      - 'test_packages_against_production_centos_8_2_7_normal'
      - 'test_packages_against_production_centos_8_2_7_jemalloc'
      - 'test_packages_against_production_centos_8_2_7_malloctrim'
      - 'test_packages_against_production_centos_8_2_6_normal'
      - 'test_packages_against_production_centos_8_2_6_jemalloc'
      - 'test_packages_against_production_centos_8_2_6_malloctrim'
      - 'test_packages_against_production_centos_8_2_5_normal'
      - 'test_packages_against_production_centos_8_2_5_jemalloc'
      - 'test_packages_against_production_centos_8_2_5_malloctrim'
      - 'test_packages_against_production_centos_8_2_7_1_normal'
      - 'test_packages_against_production_centos_8_2_7_1_jemalloc'
      - 'test_packages_against_production_centos_8_2_7_1_malloctrim'
      - 'test_packages_against_production_centos_8_2_6_6_normal'
      - 'test_packages_against_production_centos_8_2_6_6_jemalloc'
      - 'test_packages_against_production_centos_8_2_6_6_malloctrim'
      - 'test_packages_against_production_centos_8_2_5_8_normal'
      - 'test_packages_against_production_centos_8_2_5_8_jemalloc'
      - 'test_packages_against_production_centos_8_2_5_8_malloctrim'
      - 'test_packages_against_production_debian_10_2_7_normal'
      - 'test_packages_against_production_debian_10_2_7_jemalloc'
      - 'test_packages_against_production_debian_10_2_7_malloctrim'
      - 'test_packages_against_production_debian_10_2_6_normal'
      - 'test_packages_against_production_debian_10_2_6_jemalloc'
      - 'test_packages_against_production_debian_10_2_6_malloctrim'
      - 'test_packages_against_production_debian_10_2_5_normal'
      - 'test_packages_against_production_debian_10_2_5_jemalloc'
      - 'test_packages_against_production_debian_10_2_5_malloctrim'
      - 'test_packages_against_production_debian_10_2_7_1_normal'
      - 'test_packages_against_production_debian_10_2_7_1_jemalloc'
      - 'test_packages_against_production_debian_10_2_7_1_malloctrim'
      - 'test_packages_against_production_debian_10_2_6_6_normal'
      - 'test_packages_against_production_debian_10_2_6_6_jemalloc'
      - 'test_packages_against_production_debian_10_2_6_6_malloctrim'
      - 'test_packages_against_production_debian_10_2_5_8_normal'
      - 'test_packages_against_production_debian_10_2_5_8_jemalloc'
      - 'test_packages_against_production_debian_10_2_5_8_malloctrim'
      - 'test_packages_against_production_debian_9_2_7_normal'
      - 'test_packages_against_production_debian_9_2_7_jemalloc'
      - 'test_packages_against_production_debian_9_2_7_malloctrim'
      - 'test_packages_against_production_debian_9_2_6_normal'
      - 'test_packages_against_production_debian_9_2_6_jemalloc'
      - 'test_packages_against_production_debian_9_2_6_malloctrim'
      - 'test_packages_against_production_debian_9_2_5_normal'
      - 'test_packages_against_production_debian_9_2_5_jemalloc'
      - 'test_packages_against_production_debian_9_2_5_malloctrim'
      - 'test_packages_against_production_debian_9_2_7_1_normal'
      - 'test_packages_against_production_debian_9_2_7_1_jemalloc'
      - 'test_packages_against_production_debian_9_2_7_1_malloctrim'
      - 'test_packages_against_production_debian_9_2_6_6_normal'
      - 'test_packages_against_production_debian_9_2_6_6_jemalloc'
      - 'test_packages_against_production_debian_9_2_6_6_malloctrim'
      - 'test_packages_against_production_debian_9_2_5_8_normal'
      - 'test_packages_against_production_debian_9_2_5_8_jemalloc'
      - 'test_packages_against_production_debian_9_2_5_8_malloctrim'
      - 'test_packages_against_production_ubuntu_18_04_2_7_normal'
      - 'test_packages_against_production_ubuntu_18_04_2_7_jemalloc'
      - 'test_packages_against_production_ubuntu_18_04_2_7_malloctrim'
      - 'test_packages_against_production_ubuntu_18_04_2_6_normal'
      - 'test_packages_against_production_ubuntu_18_04_2_6_jemalloc'
      - 'test_packages_against_production_ubuntu_18_04_2_6_malloctrim'
      - 'test_packages_against_production_ubuntu_18_04_2_5_normal'
      - 'test_packages_against_production_ubuntu_18_04_2_5_jemalloc'
      - 'test_packages_against_production_ubuntu_18_04_2_5_malloctrim'
      - 'test_packages_against_production_ubuntu_18_04_2_7_1_normal'
      - 'test_packages_against_production_ubuntu_18_04_2_7_1_jemalloc'
      - 'test_packages_against_production_ubuntu_18_04_2_7_1_malloctrim'
      - 'test_packages_against_production_ubuntu_18_04_2_6_6_normal'
      - 'test_packages_against_production_ubuntu_18_04_2_6_6_jemalloc'
      - 'test_packages_against_production_ubuntu_18_04_2_6_6_malloctrim'
      - 'test_packages_against_production_ubuntu_18_04_2_5_8_normal'
      - 'test_packages_against_production_ubuntu_18_04_2_5_8_jemalloc'
      - 'test_packages_against_production_ubuntu_18_04_2_5_8_malloctrim'
      - 'test_packages_against_production_ubuntu_20_04_2_7_normal'
      - 'test_packages_against_production_ubuntu_20_04_2_7_jemalloc'
      - 'test_packages_against_production_ubuntu_20_04_2_7_malloctrim'
      - 'test_packages_against_production_ubuntu_20_04_2_6_normal'
      - 'test_packages_against_production_ubuntu_20_04_2_6_jemalloc'
      - 'test_packages_against_production_ubuntu_20_04_2_6_malloctrim'
      - 'test_packages_against_production_ubuntu_20_04_2_5_normal'
      - 'test_packages_against_production_ubuntu_20_04_2_5_jemalloc'
      - 'test_packages_against_production_ubuntu_20_04_2_5_malloctrim'
      - 'test_packages_against_production_ubuntu_20_04_2_7_1_normal'
      - 'test_packages_against_production_ubuntu_20_04_2_7_1_jemalloc'
      - 'test_packages_against_production_ubuntu_20_04_2_7_1_malloctrim'
      - 'test_packages_against_production_ubuntu_20_04_2_6_6_normal'
      - 'test_packages_against_production_ubuntu_20_04_2_6_6_jemalloc'
      - 'test_packages_against_production_ubuntu_20_04_2_6_6_malloctrim'
      - 'test_packages_against_production_ubuntu_20_04_2_5_8_normal'
      - 'test_packages_against_production_ubuntu_20_04_2_5_8_jemalloc'
      - 'test_packages_against_production_ubuntu_20_04_2_5_8_malloctrim'
    # We don't care whether any 'Test packages against production' jobs
    # have been skipped. We only care whether 'Publish packages to
    # production' has been skipped, because that indicates a failure
    # in one of its transitive dependencies (e.g. 'Test packages against test'
    # or 'Build Ruby').
    if: |
      needs.publish_packages_production.result == 'success'
      && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Determine latest release version
        # Sets environment variable $LATEST_RELEASE_TAG
        run: ./internal-scripts/ci-cd/check-version-numbers-need-changing/determine-latest-release-tag.sh

      - name: Determine next epic version
        # Sets environment variable $NEXT_RELEASE_VERSION
        run: ./internal-scripts/ci-cd/create-git-tag/determine-next-epic-version.sh

      - name: Create Git tag
        run: git tag epic-${{ env.NEXT_RELEASE_VERSION }}

      - name: Push Git tag
        if: github.ref == 'refs/heads/main'
        run: git push origin epic-${{ env.NEXT_RELEASE_VERSION }}
